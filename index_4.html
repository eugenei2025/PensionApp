<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Drawdown Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .warning-banner {
            background: #e74c3c;
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }

        .warning-banner.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .summary-card h3 {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .summary-card .subtitle {
            font-size: 0.85em;
            color: #95a5a6;
            margin-top: 5px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .controls-header h2 {
            font-size: 1.5em;
        }

        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .toggle-btn:hover {
            background: #5568d3;
        }

        .controls-body {
            padding-top: 20px;
        }

        .controls-body.collapsed {
            display: none;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            padding: 0 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            padding: 10px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .slider-container {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 10px;
        }

        .slider-container h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-group input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            font-weight: bold;
            color: #667eea;
            min-width: 80px;
            text-align: right;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            height: 450px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-container h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: right;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child {
            text-align: left;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
            text-align: right;
        }

        td:first-child {
            text-align: left;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .editable-cell {
            cursor: pointer;
            position: relative;
            background: #fff9e6;
        }

        .editable-cell:hover {
            background: #fff3cc;
        }

        .editable-cell input {
            width: 100%;
            padding: 5px;
            border: 2px solid #667eea;
            border-radius: 4px;
            text-align: right;
            font-size: 0.9em;
        }

        .negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .positive {
            color: #27ae60;
        }

        .help-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .help-section h2 {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2c3e50;
        }

        .help-content {
            padding-top: 20px;
            line-height: 1.8;
        }

        .help-content.collapsed {
            display: none;
        }

        .help-content h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .help-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .help-content li {
            margin-bottom: 8px;
        }

        .info-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 8px;
            cursor: help;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .input-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 350px;
                padding: 15px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üí∞ Pension Drawdown Calculator</h1>
        <p>Plan your retirement income with confidence</p>
    </header>

    <div class="container">
        <div class="warning-banner" id="warningBanner">
            ‚ö†Ô∏è Warning: Pension pot depleted before age 90!
        </div>

        <div class="summary-grid" id="summaryCards">
            <!-- Summary cards will be generated by JavaScript -->
        </div>

        <div class="controls">
            <div class="controls-header" onclick="toggleControls()">
                <h2>üìä Input Parameters</h2>
                <button class="toggle-btn" id="toggleControlsBtn">Hide Inputs</button>
            </div>
            <div class="controls-body" id="controlsBody">
                <div class="input-section">
                    <h3>üåç Global Settings</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="pensionGrowthRate">DB/State Pension Growth Rate (%)</label>
                            <input type="number" id="pensionGrowthRate" step="0.1" min="0" max="10" value="3">
                        </div>
                        <div class="input-group">
                            <label for="parmenionGrowthRate">Parmenion Pot Growth Rate (%)</label>
                            <input type="number" id="parmenionGrowthRate" step="0.1" min="0" max="15" value="6">
                        </div>
                        <div class="input-group">
                            <label for="inflationRate">Inflation Rate (%)</label>
                            <input type="number" id="inflationRate" step="0.1" min="0" max="10" value="3">
                        </div>
                        <div class="input-group">
                            <label for="personalAllowance">Personal Tax Allowance (¬£)</label>
                            <input type="number" id="personalAllowance" step="100" min="0" value="12570">
                        </div>
                        <div class="input-group">
                            <label for="basicRateThreshold">Basic Rate Upper Threshold (¬£)</label>
                            <input type="number" id="basicRateThreshold" step="100" min="0" value="50270">
                        </div>
                        <div class="input-group">
                            <label for="higherRateThreshold">Higher Rate Upper Threshold (¬£)</label>
                            <input type="number" id="higherRateThreshold" step="100" min="0" value="125140">
                        </div>
                    </div>


                </div>

                <div class="input-section">
                    <h3>üë® Eugene's Details</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="eugeneAge">Current Age</label>
                            <input type="number" id="eugeneAge" min="18" max="100" value="61">
                        </div>
                        <div class="input-group">
                            <label for="eugenePot1">Parmenion Pot 1 (¬£) <span class="info-badge" title="Already took 25% tax-free lump sum">Tax-free taken</span></label>
                            <input type="number" id="eugenePot1" step="1000" min="0" value="285135">
                        </div>
                        <div class="input-group">
                            <label for="eugenePot2">Parmenion Pot 2 (¬£) <span class="info-badge" title="Will take 25% tax-free at age 66">Tax-free at 66</span></label>
                            <input type="number" id="eugenePot2" step="1000" min="0" value="54011">
                        </div>
                        <div class="input-group">
                            <label for="eugeneMonthlyContribution">Monthly Contribution (¬£)</label>
                            <input type="number" id="eugeneMonthlyContribution" step="100" min="0" value="1000">
                        </div>
                        <div class="input-group">
                            <label for="eugeneTargetIncome">Default Target Annual Gross Income (¬£)</label>
                            <input type="number" id="eugeneTargetIncome" step="1000" min="0" value="46000">
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="eugeneInflationAdjust" checked>
                                <label for="eugeneInflationAdjust">Apply inflation to target income</label>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="eugeneStatePensionAge">State Pension Start Age</label>
                            <input type="number" id="eugeneStatePensionAge" min="60" max="80" value="67">
                        </div>
                        <div class="input-group">
                            <label for="eugeneStatePensionAmount">State Pension Annual Amount (¬£)</label>
                            <input type="number" id="eugeneStatePensionAmount" step="100" min="0" value="12014">
                        </div>
                        <div class="input-group">
                            <label for="eugeneAvonAge">Avon Pension Start Age</label>
                            <input type="number" id="eugeneAvonAge" min="0" max="80" value="66">
                        </div>
                        <div class="input-group">
                            <label for="eugeneAvonAmount">Avon Pension Annual Amount (¬£)</label>
                            <input type="number" id="eugeneAvonAmount" step="100" min="0" value="5900">
                        </div>
                        <div class="input-group">
                            <label for="eugeneCivilAge">Civil Service Pension Start Age</label>
                            <input type="number" id="eugeneCivilAge" min="0" max="80" value="66">
                        </div>
                        <div class="input-group">
                            <label for="eugeneCivilAmount">Civil Service Pension Annual Amount (¬£)</label>
                            <input type="number" id="eugeneCivilAmount" step="100" min="0" value="4850">
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <h3>üë© Annabelle's Details</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="annabelleAge">Current Age</label>
                            <input type="number" id="annabelleAge" min="18" max="100" value="52">
                        </div>
                        <div class="input-group">
                            <label for="annabelleStartingPot">Starting Parmenion Pot (¬£)</label>
                            <input type="number" id="annabelleStartingPot" step="1000" min="0" value="55273">
                        </div>
                        <div class="input-group">
                            <label for="annabelleMonthlyContribution">Monthly Contribution (¬£)</label>
                            <input type="number" id="annabelleMonthlyContribution" step="100" min="0" value="2500">
                        </div>
                        <div class="input-group">
                            <label for="annabelleTargetIncome">Default Target Annual Gross Income (¬£)</label>
                            <input type="number" id="annabelleTargetIncome" step="1000" min="0" value="12500">
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="annabelleInflationAdjust">
                                <label for="annabelleInflationAdjust">Apply inflation to target income</label>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="annabelleStatePensionAge">State Pension Start Age</label>
                            <input type="number" id="annabelleStatePensionAge" min="60" max="80" value="67">
                        </div>
                        <div class="input-group">
                            <label for="annabelleStatePensionAmount">State Pension Annual Amount (¬£)</label>
                            <input type="number" id="annabelleStatePensionAmount" step="100" min="0" value="12014">
                        </div>
                        <div class="input-group">
                            <label for="annabelleTeachersAge">Teachers Pension Start Age</label>
                            <input type="number" id="annabelleTeachersAge" min="0" max="80" value="66">
                        </div>
                        <div class="input-group">
                            <label for="annabelleTeachersAmount">Teachers Pension Annual Amount (¬£)</label>
                            <input type="number" id="annabelleTeachersAmount" step="100" min="0" value="3800">
                        </div>
                        <div class="input-group">
                            <label for="annabelleTeachersLumpSumYear">Teachers Lump Sum Year (0 = none)</label>
                            <input type="number" id="annabelleTeachersLumpSumYear" min="0" max="2100" value="2038">
                        </div>
                        <div class="input-group">
                            <label for="annabelleTeachersLumpSum">Teachers Lump Sum (¬£)</label>
                            <input type="number" id="annabelleTeachersLumpSum" step="1000" min="0" value="25888">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="calculate()">üîÑ Recalculate</button>
                    <button class="btn btn-secondary" onclick="resetToDefaults()">‚Ü∫ Reset to Defaults</button>
                    <button class="btn btn-secondary" onclick="exportToCSV()">üì• Export to CSV</button>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="pensionChart"></canvas>
        </div>

        <div class="table-container">
            <h2>üìã Year-by-Year Projection <span style="font-size: 0.8em; color: #7f8c8d;">(Click target income cells to edit)</span></h2>
            <div style="max-height: 600px; overflow-y: auto;">
                <table id="projectionTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>E Age</th>
                            <th>A Age</th>
                            <th>E Target (¬£)</th>
                            <th>A Target (¬£)</th>
                            <th>Joint Target (¬£)</th>
                            <th>E Pot Total (¬£)</th>
                            <th>A Pot (¬£)</th>
                            <th>E DB Income (¬£)</th>
                            <th>A DB Income (¬£)</th>
                            <th>E Drawdown (¬£)</th>
                            <th>A Drawdown (¬£)</th>
                            <th>E Gross (¬£)</th>
                            <th>A Gross (¬£)</th>
                            <th>Joint Gross (¬£)</th>
                            <th>E Net (¬£)</th>
                            <th>A Net (¬£)</th>
                            <th>Joint Net (¬£)</th>
                        </tr>
                    </thead>
                    <tbody id="projectionTableBody">
                        <!-- Rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="help-section">
            <h2 onclick="toggleHelp()">
                üìñ How to Use This Calculator
                <span id="helpToggle">‚ñº</span>
            </h2>
            <div class="help-content collapsed" id="helpContent">
                <h3>Overview</h3>
                <p>This calculator projects pension drawdowns for Eugene and Annabelle, accounting for defined benefit pensions, state pensions, private pension pots (Parmenion), contributions, growth, inflation, and UK tax.</p>

                <h3>Key Features</h3>
                <ul>
                    <li><strong>Eugene's Two Pots:</strong> Pot 1 (¬£285,135) has already used the 25% tax-free lump sum. Pot 2 (¬£54,011) will take 25% tax-free at age 66. Drawdowns come from the combined total.</li>
                    <li><strong>Adjustable Annual Income:</strong> Click on any target income cell in the table to adjust income for specific years. This allows precise control over drawdowns and tax planning.</li>
                    <li><strong>Pot Depletion:</strong> When a Parmenion pot reaches zero, it cannot go negative. Income is then limited to DB/State pensions only.</li>
                    <li><strong>Annabelle's Strategy:</strong> Before Teachers/State pension starts, Annabelle draws just below the personal tax allowance (¬£12,500) to maximize tax efficiency.</li>
                    <li><strong>Contributions Stop 2029:</strong> Monthly contributions for both Eugene and Annabelle stop at the start of 2029.</li>
                </ul>

                <h3>Calculation Logic</h3>
                <p><strong>Parmenion Pot Growth:</strong></p>
                <p>Next Year Pot = (Current Pot + Annual Contributions) √ó (1 + Growth Rate) - Annual Drawdown</p>

                <p><strong>Eugene's Tax-Free Lump Sum:</strong></p>
                <p>At age 66, 25% of Pot 2 (¬£13,502.75) is withdrawn tax-free and added to the combined pot.</p>

                <p><strong>Drawdown Strategy:</strong></p>
                <ul>
                    <li>Each person draws from their own pot to meet their target income</li>
                    <li>Drawdown = Target Income - DB/State Pensions (for that person)</li>
                    <li>Special rule: Annabelle draws ¬£12,500 (capped) until her DB pensions start</li>
                    <li>Drawdowns cannot exceed available pot balances (pots cannot go negative)</li>
                    <li>Adjust individual target incomes in the table to optimize household tax liability</li>
                </ul>

                <p><strong>UK Tax Calculation:</strong></p>
                <ul>
                    <li>0% on income up to Personal Allowance (¬£12,570)</li>
                    <li>20% on income from ¬£12,570 to ¬£50,270 (Basic Rate)</li>
                    <li>40% on income from ¬£50,270 to ¬£125,140 (Higher Rate)</li>
                    <li>45% on income above ¬£125,140 (Additional Rate)</li>
                </ul>

                <h3>Editing Annual Target Incomes</h3>
                <p>Click any cell in the "E Target" or "A Target" columns to edit income for that specific year. Press Enter to save. This overrides the default target income and inflation adjustment for that year, allowing you to model specific scenarios like:</p>
                <ul>
                    <li>Reduced income during early retirement</li>
                    <li>Increased income for major expenses (home renovation, travel)</li>
                    <li>Gradual income reduction as you age</li>
                    <li>Tax optimization by adjusting who takes more income in high-tax years</li>
                </ul>

                <h3>Tips</h3>
                <ul>
                    <li>Adjust individual target incomes to balance tax liabilities between Eugene and Annabelle</li>
                    <li>Use the Joint Gross and individual Gross columns to see total income targets</li>
                    <li>Adjust target incomes in specific years to model life events</li>
                    <li>Watch the warning banner for pot depletion alerts</li>
                    <li>Use "Export to CSV" to analyze data in Excel</li>
                    <li>Your inputs are saved automatically and restored when you return</li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        <p>üí° This calculator is for illustrative purposes only and should not be considered financial advice.</p>
        <p>Always consult a qualified financial adviser for personalized pension planning.</p>
    </footer>

    <script>
        class PensionCalculator {
            constructor() {
                this.params = {};
                this.projections = [];
                this.chart = null;
                this.yearlyOverrides = {}; // Store user-edited target incomes by year
                this.loadFromStorage();
                this.setupEventListeners();
                this.calculate();
            }

            loadFromStorage() {
                const saved = localStorage.getItem('pensionCalculatorParams');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.restoreInputs(data.params);
                        this.yearlyOverrides = data.yearlyOverrides || {};
                    } catch (e) {
                        console.error('Failed to load saved parameters:', e);
                    }
                }
            }

            saveToStorage() {
                try {
                    const data = {
                        params: this.collectParams(),
                        yearlyOverrides: this.yearlyOverrides
                    };
                    localStorage.setItem('pensionCalculatorParams', JSON.stringify(data));
                } catch (e) {
                    console.error('Failed to save parameters:', e);
                }
            }

            restoreInputs(params) {
                Object.keys(params).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = params[key];
                        } else {
                            element.value = params[key];
                        }
                    }
                });
            }

            setupEventListeners() {
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        this.saveToStorage();
                        this.calculate();
                    });
                });
            }

            collectParams() {
                return {
                    // Global
                    pensionGrowthRate: parseFloat(document.getElementById('pensionGrowthRate').value) / 100,
                    parmenionGrowthRate: parseFloat(document.getElementById('parmenionGrowthRate').value) / 100,
                    inflationRate: parseFloat(document.getElementById('inflationRate').value) / 100,
                    personalAllowance: parseFloat(document.getElementById('personalAllowance').value),
                    basicRateThreshold: parseFloat(document.getElementById('basicRateThreshold').value),
                    higherRateThreshold: parseFloat(document.getElementById('higherRateThreshold').value),
                    
                    // Eugene
                    eugeneAge: parseInt(document.getElementById('eugeneAge').value),
                    eugenePot1: parseFloat(document.getElementById('eugenePot1').value),
                    eugenePot2: parseFloat(document.getElementById('eugenePot2').value),
                    eugeneMonthlyContribution: parseFloat(document.getElementById('eugeneMonthlyContribution').value),
                    eugeneTargetIncome: parseFloat(document.getElementById('eugeneTargetIncome').value),
                    eugeneInflationAdjust: document.getElementById('eugeneInflationAdjust').checked,
                    eugeneStatePensionAge: parseInt(document.getElementById('eugeneStatePensionAge').value),
                    eugeneStatePensionAmount: parseFloat(document.getElementById('eugeneStatePensionAmount').value),
                    eugeneAvonAge: parseInt(document.getElementById('eugeneAvonAge').value),
                    eugeneAvonAmount: parseFloat(document.getElementById('eugeneAvonAmount').value),
                    eugeneCivilAge: parseInt(document.getElementById('eugeneCivilAge').value),
                    eugeneCivilAmount: parseFloat(document.getElementById('eugeneCivilAmount').value),
                    
                    // Annabelle
                    annabelleAge: parseInt(document.getElementById('annabelleAge').value),
                    annabelleStartingPot: parseFloat(document.getElementById('annabelleStartingPot').value),
                    annabelleMonthlyContribution: parseFloat(document.getElementById('annabelleMonthlyContribution').value),
                    annabelleTargetIncome: parseFloat(document.getElementById('annabelleTargetIncome').value),
                    annabelleInflationAdjust: document.getElementById('annabelleInflationAdjust').checked,
                    annabelleStatePensionAge: parseInt(document.getElementById('annabelleStatePensionAge').value),
                    annabelleStatePensionAmount: parseFloat(document.getElementById('annabelleStatePensionAmount').value),
                    annabelleTeachersAge: parseInt(document.getElementById('annabelleTeachersAge').value),
                    annabelleTeachersAmount: parseFloat(document.getElementById('annabelleTeachersAmount').value),
                    annabelleTeachersLumpSumYear: parseInt(document.getElementById('annabelleTeachersLumpSumYear').value),
                    annabelleTeachersLumpSum: parseFloat(document.getElementById('annabelleTeachersLumpSum').value)
                };
            }

            calculateTax(grossIncome, personalAllowance, basicThreshold, higherThreshold) {
                let tax = 0;
                let taxableIncome = Math.max(0, grossIncome - personalAllowance);
                
                if (taxableIncome <= 0) return 0;
                
                // Basic rate band
                const basicBandWidth = basicThreshold - personalAllowance;
                if (taxableIncome <= basicBandWidth) {
                    tax = taxableIncome * 0.2;
                } else {
                    tax = basicBandWidth * 0.2;
                    
                    // Higher rate band
                    const higherBandWidth = higherThreshold - basicThreshold;
                    const higherRateIncome = Math.min(taxableIncome - basicBandWidth, higherBandWidth);
                    tax += higherRateIncome * 0.4;
                    
                    // Additional rate (45%) above higher threshold
                    if (taxableIncome > higherBandWidth + basicBandWidth) {
                        const additionalIncome = taxableIncome - higherBandWidth - basicBandWidth;
                        tax += additionalIncome * 0.45;
                    }
                }
                
                return tax;
            }

            calculate() {
                this.params = this.collectParams();
                this.projections = [];
                
                const currentYear = new Date().getFullYear();
                const maxYears = 40;
                
                let eugenePot1 = this.params.eugenePot1;
                let eugenePot2 = this.params.eugenePot2;
                let annabellePot = this.params.annabelleStartingPot;
                let eugeneStatePension = 0;
                let eugeneAvonPension = 0;
                let eugeneCivilPension = 0;
                let annabelleStatePension = 0;
                let annabelleTeachersPension = 0;
                let eugeneTargetCurrent = this.params.eugeneTargetIncome;
                let annabelleTargetCurrent = this.params.annabelleTargetIncome;
                let pot2TaxFreeTaken = false;
                
                for (let year = 0; year < maxYears; year++) {
                    const calendarYear = currentYear + year;
                    const eugeneAge = this.params.eugeneAge + year;
                    const annabelleAge = this.params.annabelleAge + year;
                    
                    // Check if we should stop
                    if (eugeneAge > 90 && annabelleAge > 90) break;
                    
                    // Check for yearly overrides
                    if (this.yearlyOverrides[calendarYear]) {
                        if (this.yearlyOverrides[calendarYear].eugeneTarget !== undefined) {
                            eugeneTargetCurrent = this.yearlyOverrides[calendarYear].eugeneTarget;
                        }
                        if (this.yearlyOverrides[calendarYear].annabelleTarget !== undefined) {
                            annabelleTargetCurrent = this.yearlyOverrides[calendarYear].annabelleTarget;
                        }
                    }
                    
                    // Update DB/State pensions
                    if (eugeneAge >= this.params.eugeneStatePensionAge && eugeneStatePension === 0) {
                        eugeneStatePension = this.params.eugeneStatePensionAmount;
                    } else if (eugeneStatePension > 0) {
                        eugeneStatePension *= (1 + this.params.pensionGrowthRate);
                    }
                    
                    if (eugeneAge >= this.params.eugeneAvonAge && eugeneAvonPension === 0) {
                        eugeneAvonPension = this.params.eugeneAvonAmount;
                    } else if (eugeneAvonPension > 0) {
                        eugeneAvonPension *= (1 + this.params.pensionGrowthRate);
                    }
                    
                    if (eugeneAge >= this.params.eugeneCivilAge && eugeneCivilPension === 0) {
                        eugeneCivilPension = this.params.eugeneCivilAmount;
                    } else if (eugeneCivilPension > 0) {
                        eugeneCivilPension *= (1 + this.params.pensionGrowthRate);
                    }
                    
                    if (annabelleAge >= this.params.annabelleStatePensionAge && annabelleStatePension === 0) {
                        annabelleStatePension = this.params.annabelleStatePensionAmount;
                    } else if (annabelleStatePension > 0) {
                        annabelleStatePension *= (1 + this.params.pensionGrowthRate);
                    }
                    
                    if (annabelleAge >= this.params.annabelleTeachersAge && annabelleTeachersPension === 0) {
                        annabelleTeachersPension = this.params.annabelleTeachersAmount;
                    } else if (annabelleTeachersPension > 0) {
                        annabelleTeachersPension *= (1 + this.params.pensionGrowthRate);
                    }
                    
                    // Eugene's 25% tax-free lump sum from Pot 2 at age 66
                    let pot2TaxFreeLumpSum = 0;
                    if (eugeneAge === 66 && !pot2TaxFreeTaken && eugenePot2 > 0) {
                        pot2TaxFreeLumpSum = eugenePot2 * 0.25;
                        eugenePot2 -= pot2TaxFreeLumpSum;
                        pot2TaxFreeTaken = true;
                    }
                    
                    // Calculate total DB income
                    const eugeneDBIncome = eugeneStatePension + eugeneAvonPension + eugeneCivilPension;
                    const annabelleDBIncome = annabelleStatePension + annabelleTeachersPension;
                    
                    // Calculate drawdown needs
                    let eugeneDrawdownNeed = Math.max(0, eugeneTargetCurrent - eugeneDBIncome);
                    let annabelleDrawdownNeed = Math.max(0, annabelleTargetCurrent - annabelleDBIncome);
                    
                    // Special rule for Annabelle before her DB pensions start
                    // She should draw just below personal allowance (¬£12,500)
                    if (annabelleTeachersPension === 0 && annabelleStatePension === 0) {
                        const personalAllowanceCap = 12500; // or this.params.personalAllowance
                        annabelleDrawdownNeed = Math.min(personalAllowanceCap, annabelleTargetCurrent);
                    }
                    
                    const eugeneTotalPot = eugenePot1 + eugenePot2;
                    
                    // Each person draws what they need from their own pot, capped by pot balance
                    let eugeneDrawdown = Math.max(0, Math.min(eugeneDrawdownNeed, eugeneTotalPot));
                    let annabelleDrawdown = Math.max(0, Math.min(annabelleDrawdownNeed, annabellePot));
                    
                    // Calculate gross and tax
                    const eugeneGross = eugeneDBIncome + eugeneDrawdown + pot2TaxFreeLumpSum;
                    const annabelleGross = annabelleDBIncome + annabelleDrawdown;
                    
                    // Tax-free lump sum is not taxed, so calculate tax on income only
                    const eugeneTaxableGross = eugeneDBIncome + eugeneDrawdown;
                    const eugeneTax = this.calculateTax(eugeneTaxableGross, this.params.personalAllowance, 
                                                       this.params.basicRateThreshold, this.params.higherRateThreshold);
                    const annabelleTax = this.calculateTax(annabelleGross, this.params.personalAllowance,
                                                          this.params.basicRateThreshold, this.params.higherRateThreshold);
                    
                    const eugeneNet = eugeneGross - eugeneTax;
                    const annabelleNet = annabelleGross - annabelleTax;
                    const jointNet = eugeneNet + annabelleNet;
                    
                    // Store projection for current year
                    this.projections.push({
                        year: calendarYear,
                        eugeneAge,
                        annabelleAge,
                        eugeneTarget: eugeneTargetCurrent,
                        annabelleTarget: annabelleTargetCurrent,
                        eugenePot1,
                        eugenePot2,
                        eugeneTotalPot,
                        annabellePot,
                        eugeneDBIncome,
                        annabelleDBIncome,
                        eugeneDrawdown,
                        annabelleDrawdown,
                        eugeneGross,
                        annabelleGross,
                        eugeneTax,
                        annabelleTax,
                        eugeneNet,
                        annabelleNet,
                        jointNet,
                        pot2TaxFreeLumpSum
                    });
                    
                    // Update pots for next year
                    // Add contributions (stop at start of 2029)
                    const eugeneContributions = calendarYear < 2029 ? this.params.eugeneMonthlyContribution * 12 : 0;
                    const annabelleContributions = calendarYear < 2029 ? this.params.annabelleMonthlyContribution * 12 : 0;
                    
                    // Add lump sum if applicable
                    let annabelleLumpSum = 0;
                    if (this.params.annabelleTeachersLumpSumYear > 0 && calendarYear === this.params.annabelleTeachersLumpSumYear) {
                        annabelleLumpSum = this.params.annabelleTeachersLumpSum;
                    }
                    
                    // Calculate next year's pots
                    // For Eugene, distribute drawdown proportionally between his two pots
                    const eugeneCurrentTotal = eugenePot1 + eugenePot2;
                    let pot1Drawdown = 0;
                    let pot2Drawdown = 0;
                    
                    if (eugeneCurrentTotal > 0) {
                        pot1Drawdown = eugeneDrawdown * (eugenePot1 / eugeneCurrentTotal);
                        pot2Drawdown = eugeneDrawdown * (eugenePot2 / eugeneCurrentTotal);
                    }
                    
                    // Grow pots
                    eugenePot1 = Math.max(0, (eugenePot1 + eugeneContributions * 0.5 + pot2TaxFreeLumpSum) * (1 + this.params.parmenionGrowthRate) - pot1Drawdown);
                    eugenePot2 = Math.max(0, (eugenePot2 + eugeneContributions * 0.5) * (1 + this.params.parmenionGrowthRate) - pot2Drawdown);
                    annabellePot = Math.max(0, (annabellePot + annabelleContributions + annabelleLumpSum) * (1 + this.params.parmenionGrowthRate) - annabelleDrawdown);
                    
                    // Update target income with inflation if enabled (and no override for next year)
                    if (!this.yearlyOverrides[calendarYear + 1]) {
                        if (this.params.eugeneInflationAdjust) {
                            eugeneTargetCurrent *= (1 + this.params.inflationRate);
                        }
                        if (this.params.annabelleInflationAdjust) {
                            annabelleTargetCurrent *= (1 + this.params.inflationRate);
                        }
                    }
                }
                
                this.updateDisplay();
            }

            updateDisplay() {
                this.updateSummaryCards();
                this.updateTable();
                this.updateChart();
                this.checkWarnings();
            }

            updateSummaryCards() {
                const eugene85 = this.projections.find(p => p.eugeneAge === 85) || this.projections[this.projections.length - 1];
                const annabelle85 = this.projections.find(p => p.annabelleAge === 85) || this.projections[this.projections.length - 1];
                
                const html = `
                    <div class="summary-card">
                        <h3>Eugene's Total Pot at 85</h3>
                        <div class="value ${eugene85?.eugeneTotalPot < 0 ? 'negative' : 'positive'}">¬£${this.formatNumber(eugene85?.eugeneTotalPot || 0)}</div>
                        <div class="subtitle">Pot1: ¬£${this.formatNumber(eugene85?.eugenePot1 || 0)} | Pot2: ¬£${this.formatNumber(eugene85?.eugenePot2 || 0)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Annabelle's Pot at 85</h3>
                        <div class="value ${annabelle85?.annabellePot < 0 ? 'negative' : 'positive'}">¬£${this.formatNumber(annabelle85?.annabellePot || 0)}</div>
                        <div class="subtitle">Year ${annabelle85?.year || 'N/A'}</div>
                    </div>
                `;
                
                document.getElementById('summaryCards').innerHTML = html;
            }

            updateTable() {
                const tbody = document.getElementById('projectionTableBody');
                let html = '';
                
                this.projections.forEach(p => {
                    const jointTarget = p.eugeneTarget + p.annabelleTarget;
                    const jointGross = p.eugeneGross + p.annabelleGross;
                    
                    html += `
                        <tr>
                            <td>${p.year}</td>
                            <td>${p.eugeneAge}</td>
                            <td>${p.annabelleAge}</td>
                            <td class="editable-cell" data-year="${p.year}" data-person="eugene" onclick="calculator.editTargetIncome(${p.year}, 'eugene', ${p.eugeneTarget})">¬£${this.formatNumber(p.eugeneTarget)}</td>
                            <td class="editable-cell" data-year="${p.year}" data-person="annabelle" onclick="calculator.editTargetIncome(${p.year}, 'annabelle', ${p.annabelleTarget})">¬£${this.formatNumber(p.annabelleTarget)}</td>
                            <td>¬£${this.formatNumber(jointTarget)}</td>
                            <td class="${p.eugeneTotalPot <= 0 ? 'negative' : ''}">¬£${this.formatNumber(p.eugeneTotalPot)}</td>
                            <td class="${p.annabellePot <= 0 ? 'negative' : ''}">¬£${this.formatNumber(p.annabellePot)}</td>
                            <td>¬£${this.formatNumber(p.eugeneDBIncome)}</td>
                            <td>¬£${this.formatNumber(p.annabelleDBIncome)}</td>
                            <td>¬£${this.formatNumber(p.eugeneDrawdown)}</td>
                            <td>¬£${this.formatNumber(p.annabelleDrawdown)}</td>
                            <td>¬£${this.formatNumber(p.eugeneGross)}</td>
                            <td>¬£${this.formatNumber(p.annabelleGross)}</td>
                            <td>¬£${this.formatNumber(jointGross)}</td>
                            <td class="positive">¬£${this.formatNumber(p.eugeneNet)}</td>
                            <td class="positive">¬£${this.formatNumber(p.annabelleNet)}</td>
                            <td class="positive">¬£${this.formatNumber(p.jointNet)}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            }

            editTargetIncome(year, person, currentValue) {
                const cell = event.target;
                const input = document.createElement('input');
                input.type = 'number';
                input.value = Math.round(currentValue);
                input.step = 1000;
                input.min = 0;
                
                const originalContent = cell.innerHTML;
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
                
                const saveValue = () => {
                    const newValue = parseFloat(input.value);
                    if (!isNaN(newValue) && newValue >= 0) {
                        if (!this.yearlyOverrides[year]) {
                            this.yearlyOverrides[year] = {};
                        }
                        this.yearlyOverrides[year][person === 'eugene' ? 'eugeneTarget' : 'annabelleTarget'] = newValue;
                        this.saveToStorage();
                        this.calculate();
                    } else {
                        cell.innerHTML = originalContent;
                    }
                };
                
                input.addEventListener('blur', saveValue);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveValue();
                    } else if (e.key === 'Escape') {
                        cell.innerHTML = originalContent;
                    }
                });
            }

            updateChart() {
                const ctx = document.getElementById('pensionChart').getContext('2d');
                
                const labels = this.projections.map(p => p.year);
                const eugeneTotalPotData = this.projections.map(p => p.eugeneTotalPot);
                const eugenePot1Data = this.projections.map(p => p.eugenePot1);
                const eugenePot2Data = this.projections.map(p => p.eugenePot2);
                const annabellePotData = this.projections.map(p => p.annabellePot);
                
                if (this.chart) {
                    this.chart.destroy();
                }
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Eugene Total Pot',
                                data: eugeneTotalPotData,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3
                            },
                            {
                                label: 'Eugene Pot 1',
                                data: eugenePot1Data,
                                borderColor: '#9ba5ea',
                                backgroundColor: 'rgba(155, 165, 234, 0.05)',
                                tension: 0.3,
                                fill: false,
                                borderWidth: 1,
                                borderDash: [5, 5]
                            },
                            {
                                label: 'Eugene Pot 2',
                                data: eugenePot2Data,
                                borderColor: '#b5bfea',
                                backgroundColor: 'rgba(181, 191, 234, 0.05)',
                                tension: 0.3,
                                fill: false,
                                borderWidth: 1,
                                borderDash: [5, 5]
                            },
                            {
                                label: 'Annabelle\'s Pot',
                                data: annabellePotData,
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Parmenion Pension Pots Over Time',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ¬£' + context.parsed.y.toLocaleString('en-GB', {maximumFractionDigits: 0});
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '¬£' + value.toLocaleString('en-GB', {maximumFractionDigits: 0});
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            checkWarnings() {
                const banner = document.getElementById('warningBanner');
                const eugene90 = this.projections.find(p => p.eugeneAge >= 90);
                const annabelle90 = this.projections.find(p => p.annabelleAge >= 90);
                
                let hasWarning = false;
                let warningText = '‚ö†Ô∏è Warning: ';
                
                if (eugene90 && eugene90.eugeneTotalPot <= 0) {
                    hasWarning = true;
                    warningText += 'Eugene\'s pension pot depleted before age 90! ';
                }
                
                if (annabelle90 && annabelle90.annabellePot <= 0) {
                    hasWarning = true;
                    warningText += 'Annabelle\'s pension pot depleted before age 90! ';
                }
                
                // Check if any pot goes to zero at any point
                const eugeneZero = this.projections.find(p => p.eugeneTotalPot <= 0);
                const annabelleZero = this.projections.find(p => p.annabellePot <= 0);
                
                if (eugeneZero && !hasWarning) {
                    hasWarning = true;
                    warningText += `Eugene's pot depleted in year ${eugeneZero.year} (age ${eugeneZero.eugeneAge})! `;
                }
                
                if (annabelleZero && !hasWarning) {
                    hasWarning = true;
                    warningText += `Annabelle's pot depleted in year ${annabelleZero.year} (age ${annabelleZero.annabelleAge})! `;
                }
                
                if (hasWarning) {
                    banner.textContent = warningText;
                    banner.classList.add('active');
                } else {
                    banner.classList.remove('active');
                }
            }

            formatNumber(num) {
                return Math.round(num).toLocaleString('en-GB');
            }

            exportToCSV() {
                let csv = 'Year,Eugene Age,Annabelle Age,Eugene Target,Annabelle Target,Joint Target,Eugene Pot1,Eugene Pot2,Eugene Total Pot,Annabelle Pot,Eugene DB Income,Annabelle DB Income,Eugene Drawdown,Annabelle Drawdown,Eugene Gross,Annabelle Gross,Joint Gross,Eugene Tax,Annabelle Tax,Eugene Net,Annabelle Net,Joint Net\n';
                
                this.projections.forEach(p => {
                    const jointTarget = p.eugeneTarget + p.annabelleTarget;
                    const jointGross = p.eugeneGross + p.annabelleGross;
                    csv += `${p.year},${p.eugeneAge},${p.annabelleAge},${p.eugeneTarget.toFixed(2)},${p.annabelleTarget.toFixed(2)},${jointTarget.toFixed(2)},${p.eugenePot1.toFixed(2)},${p.eugenePot2.toFixed(2)},${p.eugeneTotalPot.toFixed(2)},${p.annabellePot.toFixed(2)},${p.eugeneDBIncome.toFixed(2)},${p.annabelleDBIncome.toFixed(2)},${p.eugeneDrawdown.toFixed(2)},${p.annabelleDrawdown.toFixed(2)},${p.eugeneGross.toFixed(2)},${p.annabelleGross.toFixed(2)},${jointGross.toFixed(2)},${p.eugeneTax.toFixed(2)},${p.annabelleTax.toFixed(2)},${p.eugeneNet.toFixed(2)},${p.annabelleNet.toFixed(2)},${p.jointNet.toFixed(2)}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pension-projection-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            resetToDefaults() {
                if (confirm('Reset all values to defaults? This will clear your saved settings and custom target incomes.')) {
                    localStorage.removeItem('pensionCalculatorParams');
                    this.yearlyOverrides = {};
                    location.reload();
                }
            }
        }

        // Global calculator instance
        let calculator;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculator = new PensionCalculator();
        });

        // Helper functions for UI controls
        function toggleControls() {
            const body = document.getElementById('controlsBody');
            const btn = document.getElementById('toggleControlsBtn');
            body.classList.toggle('collapsed');
            btn.textContent = body.classList.contains('collapsed') ? 'Show Inputs' : 'Hide Inputs';
        }

        function toggleHelp() {
            const content = document.getElementById('helpContent');
            const toggle = document.getElementById('helpToggle');
            content.classList.toggle('collapsed');
            toggle.textContent = content.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
        }

        function calculate() {
            if (calculator) {
                calculator.calculate();
            }
        }

        function resetToDefaults() {
            if (calculator) {
                calculator.resetToDefaults();
            }
        }

        function exportToCSV() {
            if (calculator) {
                calculator.exportToCSV();
            }
        }
    </script>
</body>
</html>