<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pensions MAP - Pension Drawdown Model</title>
    <style>
        :root {
            --primary: #2c5282;
            --primary-light: #4299e1;
            --success: #38a169;
            --warning: #dd6b20;
            --danger: #e53e3e;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-muted: #718096;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container { max-width: 1800px; margin: 0 auto; }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        header h1 { font-size: 1.8rem; margin-bottom: 4px; }
        header p { opacity: 0.9; font-size: 0.95rem; }
        
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        
        .input-group { margin-bottom: 14px; }
        
        .input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .input-group input[type="number"],
        .input-group input[type="month"],
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }
        
        .input-row { display: flex; gap: 12px; align-items: center; }
        .input-row .input-group { flex: 1; margin-bottom: 0; }
        
        .toggle-group { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
        .toggle-group label { margin-bottom: 0; font-size: 0.9rem; }
        
        .toggle { position: relative; width: 44px; height: 24px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        
        .toggle-slider {
            position: absolute; cursor: pointer; inset: 0;
            background: #cbd5e0; border-radius: 24px; transition: 0.3s;
        }
        
        .toggle-slider:before {
            content: ""; position: absolute; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background: white;
            border-radius: 50%; transition: 0.3s;
        }
        
        .toggle input:checked + .toggle-slider { background: var(--success); }
        .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; margin-bottom: 24px;
        }
        
        .summary-card {
            background: var(--card-bg); border-radius: 10px;
            padding: 14px 16px; border: 1px solid var(--border); text-align: center;
        }
        
        .summary-card.warning { border-left: 4px solid var(--warning); }
        .summary-card.danger { border-left: 4px solid var(--danger); }
        .summary-card.success { border-left: 4px solid var(--success); }
        .summary-card.info { border-left: 4px solid var(--primary); }
        
        .summary-card .value { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .summary-card .sub-value { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); margin-top: 2px; }
        .summary-card.danger .value { color: var(--danger); }
        .summary-card.warning .value { color: var(--warning); }
        .summary-card.success .value { color: var(--success); }
        .summary-card .label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        
        .chart-container {
            background: var(--card-bg); border-radius: 10px; padding: 20px;
            border: 1px solid var(--border); margin-bottom: 24px;
        }
        
        .chart-container h2 { font-size: 1.1rem; color: var(--primary); margin-bottom: 16px; }
        
        .table-container {
            background: var(--card-bg); border-radius: 10px;
            border: 1px solid var(--border); overflow: hidden; margin-bottom: 24px;
        }
        
        .table-container h2 {
            font-size: 1.1rem; color: var(--primary);
            padding: 16px 20px; border-bottom: 1px solid var(--border); margin: 0;
        }
        
        .table-scroll { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 2200px; }
        
        .data-table th, .data-table td {
            padding: 10px 12px; text-align: right;
            border-bottom: 1px solid var(--border); white-space: nowrap;
        }
        
        .data-table th {
            background: #f8fafc; font-weight: 600; color: var(--text-muted);
            position: sticky; top: 0; z-index: 10;
        }
        
        .data-table th:first-child, .data-table td:first-child {
            text-align: left; position: sticky; left: 0; background: #f8fafc; z-index: 5;
        }
        
        .data-table td:first-child { background: var(--card-bg); }
        .data-table tr:hover td { background: #f7fafc; }
        .data-table tr:hover td:first-child { background: #f7fafc; }
        
        .negative { color: var(--danger); font-weight: 600; }
        .positive { color: var(--success); font-weight: 600; }
        .highlight { background: #fefce8 !important; }
        .exhausted { background: #fee2e2 !important; }
        .pre-drawdown { color: #a0aec0; }
        
        .section-title {
            font-size: 1.2rem; color: var(--primary); margin: 24px 0 16px;
            padding-bottom: 8px; border-bottom: 2px solid var(--primary-light);
        }
        
        .person-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        
        .person-badge {
            background: var(--primary); color: white; padding: 4px 12px;
            border-radius: 20px; font-size: 0.85rem; font-weight: 500;
        }
        
        .person-badge.secondary { background: var(--success); }
        
        .card.ei-card { border-left: 4px solid var(--primary); background: linear-gradient(135deg, #f7fafc 0%, #ebf4ff 100%); }
        .card.ai-card { border-left: 4px solid var(--success); background: linear-gradient(135deg, #f7fafc 0%, #f0fff4 100%); }
        
        .card.ei-card h2, .card.ei-card .person-badge { color: var(--primary); }
        .card.ai-card h2 { color: var(--success); }
        
        .db-section { margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border); }
        .db-section h3 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 12px; }
        
        .ei-card .db-section { border-top-color: #93c5fd; }
        .ei-card .db-section h3 { color: #1e40af; }
        .ai-card .db-section { border-top-color: #6ee7b7; }
        .ai-card .db-section h3 { color: #047857; }
        
        footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            header { padding: 16px 20px; }
            header h1 { font-size: 1.4rem; }
        }
        
        .opt-button {
            padding: 8px 16px; background: var(--primary); color: white; border: none;
            border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer;
            transition: background 0.2s, transform 0.1s; white-space: nowrap;
        }
        
        .opt-button:hover { background: var(--primary-light); }
        .opt-button:active { transform: scale(0.98); }
        
        .opt-button-primary { background: var(--success); padding: 12px 20px; font-size: 0.95rem; }
        .opt-button-primary:hover { background: #2f855a; }
        
        .opt-result {
            margin-top: 12px; padding: 12px; background: #f0fff4;
            border: 1px solid #9ae6b4; border-radius: 6px;
            font-size: 0.85rem; color: #276749; display: none;
        }
        
        .opt-result.visible { display: block; }
        .opt-result.warning { background: #fffbeb; border-color: #fbd38d; color: #975a16; }
        .opt-result.error { background: #fff5f5; border-color: #feb2b2; color: #c53030; }
        .opt-result strong { font-weight: 600; }
        
        .opt-indicator {
            display: inline-block;
            background: #805ad5;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 500;
        }
        
        .opt-indicator.tax { background: #38a169; }
        .opt-indicator.depletion { background: #dd6b20; }
        
        .alerts-section { margin: 24px 0; }
        
        .alert-box {
            background: #fff5f5; border: 1px solid #fc8181;
            border-left: 4px solid #e53e3e; border-radius: 8px;
            padding: 16px 20px; margin-bottom: 12px;
        }
        
        .alert-box.warning { background: #fffbeb; border-color: #f6ad55; border-left-color: #dd6b20; }
        .alert-box h3 { color: #c53030; font-size: 1rem; margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px; }
        .alert-box.warning h3 { color: #c05621; }
        .alert-box p { color: #742a2a; font-size: 0.9rem; margin: 0; line-height: 1.5; }
        .alert-box.warning p { color: #7b341e; }
        
        .income-limited { background: #fef3c7 !important; }
        .income-limited td { background: #fef3c7 !important; }
        
        .editable-cell { cursor: pointer; position: relative; }
        .editable-cell:hover { background: #e2e8f0 !important; }
        .editable-cell.has-override { background: #c6f6d5 !important; font-weight: 600; }
        .editable-cell.has-override::after { content: '‚úé'; font-size: 0.7rem; margin-left: 4px; color: #38a169; }
        .editable-cell input { width: 80px; padding: 4px 6px; border: 2px solid var(--primary); border-radius: 4px; font-size: 0.85rem; text-align: right; }
        
        .locked-cell { background: #fed7d7 !important; color: #742a2a; cursor: not-allowed; }
        
        .header-group th { text-align: center; }
        
        thead tr:first-child th[colspan="9"]:first-of-type { border-right: 2px solid #1a365d; }
        thead tr:first-child th[colspan="9"]:nth-of-type(2) { border-right: 2px solid #1a4731; }
        
        .data-table tbody td:nth-child(2) { border-right: 2px solid #e2e8f0; }
        .data-table tbody td:nth-child(11) { border-right: 2px solid #e2e8f0; }
        .data-table tbody td:nth-child(20) { border-right: 2px solid #e2e8f0; }
        
        .clear-all-overrides {
            background: #e53e3e; color: white; border: none; border-radius: 6px;
            padding: 8px 16px; font-size: 0.85rem; cursor: pointer; margin-top: 12px;
        }
        .clear-all-overrides:hover { background: #c53030; }
        
        .toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: #edf2f7; border-radius: 8px;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        
        .toolbar-group { display: flex; gap: 8px; }
        
        .toolbar-btn {
            padding: 8px 16px; border: 1px solid #cbd5e0; background: white;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        
        .toolbar-btn:hover { background: #f7fafc; border-color: var(--primary); }
        .toolbar-btn-print { background: var(--primary); color: white; border-color: var(--primary); }
        .toolbar-btn-print:hover { background: #1e3a5f; }
        
        .year-hint { font-size: 0.7rem; color: #805ad5; font-style: italic; font-weight: normal; }
        
        .lump-sum-section { background: #fefce8; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-top: 12px; }
        .lump-sum-section h4 { font-size: 0.85rem; color: #92400e; margin-bottom: 8px; }
        
        .ei-card .lump-sum-section { background: #eff6ff; border-color: #93c5fd; }
        .ei-card .lump-sum-section h4 { color: #1e40af; }
        .ai-card .lump-sum-section { background: #ecfdf5; border-color: #6ee7b7; }
        .ai-card .lump-sum-section h4 { color: #047857; }
        
        /* Print Summary (hidden on screen) */
        .print-summary { display: none; }
        .print-header-title { display: none; }
        
        /* ============================================================================
           PRINT STYLES
           ============================================================================ */
        @media print {
            @page { size: A4 landscape; margin: 6mm; }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            .toolbar, .card, .opt-button, .clear-all-overrides, 
            #clearAllOverrides, .grid, .alerts-section,
            .summary-grid, .chart-container, footer, .opt-result, .section-title {
                display: none !important;
            }
            
            body, .container { width: 100%; margin: 0; padding: 0; background: white !important; }
            
            header { margin-bottom: 5px; padding: 0; background: none !important; box-shadow: none; }
            header > h1, header > p { display: none !important; }
            
            .print-header-title {
                display: block !important; text-align: center;
                border-bottom: 2px solid #1a365d; padding-bottom: 5px; margin-bottom: 5px;
            }
            
            .print-header-title h1 { font-size: 16pt; margin: 0; color: #1a365d !important; }
            .print-header-title .print-date-main { font-size: 9pt; color: #333 !important; margin: 2px 0 0 0; }
            
            /* --- DATA TABLE (Page 1) --- */
            .table-container {
                border: none; overflow: visible !important; margin: 0; padding: 0;
                transform: scale(0.68); transform-origin: top left; width: 147%;
            }
            
            .table-container > div:first-child { display: none !important; }
            .table-scroll { overflow: visible !important; max-height: none !important; }
            
            .data-table { font-size: 8.5pt; width: 100%; }
            .data-table th:last-child, .data-table td:last-child { display: none !important; }
            .data-table th, .data-table td { padding: 1px 2px !important; border-bottom: 1px solid #999; color: #000 !important; }
            
            tr { page-break-inside: avoid; }
            thead { display: table-header-group; }
            
            /* --- PRINT SUMMARY (Page 2) --- */
            .print-summary {
                display: block !important; page-break-before: always;
                padding: 0; width: 100%; background: white;
            }
            
            .print-summary * { color: #000 !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pensions MAP</h1>
            <p>Model and Analyse Pensions ‚Äì Interactive Drawdown Calculator</p>
            <div id="printHeaderTitle" class="print-header-title">
                <h1 id="printTitleMain">Pension Projection</h1>
                <p class="print-date-main" id="printDateMain"></p>
            </div>
        </header>
        
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" id="saveScenario" title="Save current scenario">üíæ Save Scenario</button>
                <button class="toolbar-btn" id="loadScenario" title="Load saved scenario">üìÇ Load Scenario</button>
                <input type="file" id="loadScenarioFile" accept=".json" style="display: none;">
            </div>
            <div class="toolbar-group">
                <input type="text" id="printTitle" placeholder="Enter print title..." 
                       style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; width: 200px; font-size: 0.85rem;">
                <button class="toolbar-btn toolbar-btn-print" id="printScenario" title="Print to PDF">üñ®Ô∏è Print / PDF</button>
            </div>
        </div>

        <div class="grid grid-3">
            <div class="card">
                <h2>Global Parameters</h2>
                <div class="input-row" style="align-items: flex-end; gap: 8px;">
                    <div class="input-group" style="flex: 1;">
                        <label>DB Pension Annual Growth Rate (%)</label>
                        <input type="number" id="dbGrowthRate" value="3" step="0.1" min="0" max="20">
                    </div>
                    <div class="toggle-group" style="margin-bottom: 0; padding-bottom: 8px;">
                        <label class="toggle"><input type="checkbox" id="dbGrowthEnabled" checked><span class="toggle-slider"></span></label>
                    </div>
                </div>
                <div class="input-row" style="align-items: flex-end; gap: 8px;">
                    <div class="input-group" style="flex: 1;">
                        <label>DC (Parmenion) Growth Rate (%)</label>
                        <input type="number" id="dcGrowthRate" value="6" step="0.1" min="0" max="20">
                    </div>
                    <div class="toggle-group" style="margin-bottom: 0; padding-bottom: 8px;">
                        <label class="toggle"><input type="checkbox" id="dcGrowthEnabled" checked><span class="toggle-slider"></span></label>
                    </div>
                </div>
                <div class="input-row" style="align-items: flex-end; gap: 8px;">
                    <div class="input-group" style="flex: 1;">
                        <label>State Pension Annual Growth Rate (%)</label>
                        <input type="number" id="statePensionGrowthRate" value="3" step="0.1" min="0" max="20">
                    </div>
                    <div class="toggle-group" style="margin-bottom: 0; padding-bottom: 8px;">
                        <label class="toggle"><input type="checkbox" id="statePensionGrowthEnabled" checked><span class="toggle-slider"></span></label>
                    </div>
                </div>
                <div class="input-row" style="align-items: flex-end; gap: 8px;">
                    <div class="input-group" style="flex: 1;">
                        <label>Annual Living Costs (¬£) <span class="year-hint">(from first drawdown)</span></label>
                        <input type="number" id="annualLivingCosts" value="30000" step="500" min="0">
                    </div>
                    <div class="toggle-group" style="margin-bottom: 0; padding-bottom: 8px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted); margin-right: 4px;">Infl</span>
                        <label class="toggle"><input type="checkbox" id="livingCostsInflation"><span class="toggle-slider"></span></label>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Tax Bands & Thresholds</h2>
                <div class="input-group">
                    <label>Personal Allowance (¬£)</label>
                    <input type="number" id="personalAllowance" value="12570" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>Basic Rate Threshold (¬£)</label>
                    <input type="number" id="basicRateThreshold" value="50270" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>New Thresholds Start Year <span class="year-hint">(applies from start of year)</span></label>
                    <input type="number" id="taxNewThresholdsYear" value="2031" step="1" min="2025" max="2063">
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Tax thresholds grow at 2% p.a. from the start of New Thresholds Year.</p>
            </div>
            
            <div class="card">
                <h2>Inflation Settings</h2>
                <div class="input-group">
                    <label>Base Inflation Rate (%)</label>
                    <input type="number" id="inflationBaseRate" value="3" step="0.1" min="0" max="20">
                </div>
                <div class="input-group">
                    <label>Inflation Change Year <span class="year-hint">(applies from start of year)</span></label>
                    <input type="number" id="inflationChangeYear" value="2025" step="1" min="2025" max="2063">
                </div>
                <div class="input-group">
                    <label>New Inflation Rate (%)</label>
                    <input type="number" id="inflationNewRate" value="3" step="0.1" min="0" max="20">
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">New rate applies from start of Inflation Change Year.</p>
            </div>
        </div>

        <div class="grid grid-2" style="margin-top: 20px;">
            <div class="card ei-card">
                <div class="person-header">
                    <span class="person-badge">EI</span>
                    <h2 style="margin: 0; border: none; padding: 0;">Parameters</h2>
                    <span id="eugeneOptIndicator"></span>
                </div>
                <div class="input-row" style="margin-bottom: 14px;">
                    <div class="input-group">
                        <label>Drawdown Start Year <span class="year-hint">(from start of year)</span></label>
                        <input type="number" id="eugeneDrawdownStartYear" value="2030" step="1" min="2025" max="2054">
                    </div>
                    <div class="input-group">
                        <label>Target Gross Income (¬£)</label>
                        <input type="number" id="eugeneTargetIncome" value="50000" step="500" min="0">
                    </div>
                </div>
                <div class="toggle-group">
                    <label class="toggle"><input type="checkbox" id="eugeneInflation" checked><span class="toggle-slider"></span></label>
                    <label>Apply Inflation to Target Income</label>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Monthly Contribution (¬£)</label>
                        <input type="number" id="eugeneMonthlyContrib" value="1500" step="100" min="0">
                    </div>
                    <div class="input-group">
                        <label>Contribution Start <span class="year-hint">(month)</span></label>
                        <input type="month" id="eugeneContribStartMonth" value="2025-01">
                    </div>
                    <div class="input-group">
                        <label>Contribution Stop Year <span class="year-hint">(end of year)</span></label>
                        <input type="number" id="eugeneContribStopYear" value="2029" step="1" min="2025" max="2063">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 14px;">
                    <div class="input-group">
                        <label>Pot 1 Balance (¬£)</label>
                        <input type="number" id="eugenePot1Balance" value="286343" step="1000" min="0">
                    </div>
                    <div class="input-group">
                        <label>Pot 2 Balance (¬£)</label>
                        <input type="number" id="eugenePot2Balance" value="54239" step="1000" min="0">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 10px;">
                    <div class="input-group">
                        <label>Balance Valid From <span class="year-hint">(growth applied after)</span></label>
                        <input type="month" id="eugeneBalanceValidFrom" value="2025-01">
                    </div>
                    <div class="input-group">
                        <label>Age in 2025</label>
                        <input type="number" id="eugeneAge2025" value="61" step="1" min="18" max="100">
                    </div>
                </div>
                
                <div class="db-section">
                    <h3>Defined Benefit Pensions</h3>
                    <div class="input-row" style="margin-bottom: 10px;">
                        <div class="input-group"><label>State Pension Start <span class="year-hint">(from start)</span></label><input type="number" id="eugeneStateYear" value="2031" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>State Pension Amount (¬£/yr)</label><input type="number" id="eugeneStateAmount" value="12014" step="100" min="0"></div>
                    </div>
                    <div class="input-row" style="margin-bottom: 10px;">
                        <div class="input-group"><label>Avon Pension Start <span class="year-hint">(from start)</span></label><input type="number" id="eugeneAvonYear" value="2030" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>Avon Pension Amount (¬£/yr)</label><input type="number" id="eugeneAvonAmount" value="5900" step="100" min="0"></div>
                    </div>
                    <div class="input-row">
                        <div class="input-group"><label>Civil Service Start <span class="year-hint">(from start)</span></label><input type="number" id="eugeneCivilYear" value="2030" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>Civil Service Amount (¬£/yr)</label><input type="number" id="eugeneCivilAmount" value="4850" step="100" min="0"></div>
                    </div>
                    
                    <div class="lump-sum-section">
                        <h4>DB Pension 25% Lump Sums (static input for summary)</h4>
                        <div class="input-row">
                            <div class="input-group"><label>Avon 25% Lump Sum (¬£)</label><input type="number" id="eugeneAvonLumpSum" value="30000" step="1000" min="0"></div>
                            <div class="input-group"><label>Civil Service 25% Lump Sum (¬£)</label><input type="number" id="eugeneCivilLumpSum" value="32332" step="1000" min="0"></div>
                        </div>
                    </div>
                </div>
                
                <div class="db-section">
                    <h3>Tax-Free Lump Sum Extraction (Parmenion)</h3>
                    <div class="input-row">
                        <div class="input-group"><label>Extraction Year <span class="year-hint">(at start of year)</span></label><input type="number" id="eugeneLumpSumYear" value="2030" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>Percentage (%)</label><input type="number" id="eugeneLumpSumPct" value="25" step="1" min="0" max="25"></div>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Lump sum extracted from Pot 2 only, at start of extraction year.</p>
                </div>
            </div>
            
            <div class="card ai-card">
                <div class="person-header">
                    <span class="person-badge secondary">AI</span>
                    <h2 style="margin: 0; border: none; padding: 0;">Parameters</h2>
                    <span id="annabelleOptIndicator"></span>
                </div>
                <div class="input-row" style="margin-bottom: 14px;">
                    <div class="input-group"><label>Drawdown Start Year <span class="year-hint">(from start of year)</span></label><input type="number" id="annabelleDrawdownStartYear" value="2030" step="1" min="2025" max="2054"></div>
                    <div class="input-group"><label>Target Gross Income (¬£)</label><input type="number" id="annabelleTargetIncome" value="12500" step="500" min="0"></div>
                </div>
                <div class="toggle-group">
                    <label class="toggle"><input type="checkbox" id="annabelleInflation" checked><span class="toggle-slider"></span></label>
                    <label>Apply Inflation to Target Income</label>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Monthly Contribution (¬£)</label><input type="number" id="annabelleMonthlyContrib" value="2500" step="100" min="0"></div>
                    <div class="input-group"><label>Contribution Start <span class="year-hint">(month)</span></label><input type="month" id="annabelleContribStartMonth" value="2025-01"></div>
                    <div class="input-group"><label>Contribution Stop Year <span class="year-hint">(end of year)</span></label><input type="number" id="annabelleContribStopYear" value="2029" step="1" min="2025" max="2063"></div>
                </div>
                <div class="input-row" style="margin-top: 14px;">
                    <div class="input-group"><label>Starting Balance (¬£)</label><input type="number" id="annabelleStartingBalance" value="55273" step="1000" min="0"></div>
                    <div class="input-group"><label>Balance Valid From <span class="year-hint">(growth applied after)</span></label><input type="month" id="annabelleBalanceValidFrom" value="2025-01"></div>
                    <div class="input-group"><label>Age in 2025</label><input type="number" id="annabelleAge2025" value="53" step="1" min="18" max="100"></div>
                </div>
                
                <div class="db-section">
                    <h3>Defined Benefit Pensions</h3>
                    <div class="input-row" style="margin-bottom: 10px;">
                        <div class="input-group"><label>State Pension Start <span class="year-hint">(from start)</span></label><input type="number" id="annabelleStateYear" value="2039" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>State Pension Amount (¬£/yr)</label><input type="number" id="annabelleStateAmount" value="12014" step="100" min="0"></div>
                    </div>
                    <div class="input-row">
                        <div class="input-group"><label>Teachers Pension Start <span class="year-hint">(from start)</span></label><input type="number" id="annabelleTeachersYear" value="2038" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>Teachers Pension Amount (¬£/yr)</label><input type="number" id="annabelleTeachersAmount" value="3800" step="100" min="0"></div>
                    </div>
                    
                    <div class="lump-sum-section">
                        <h4>DB Pension 25% Lump Sum (static input for summary)</h4>
                        <div class="input-row">
                            <div class="input-group"><label>Teachers 25% Lump Sum (¬£)</label><input type="number" id="annabelleTeachersLumpSum" value="25888" step="1000" min="0"></div>
                        </div>
                    </div>
                </div>
                
                <div class="db-section">
                    <h3>Tax-Free Lump Sum Extraction (Parmenion)</h3>
                    <div class="input-row">
                        <div class="input-group"><label>Extraction Year <span class="year-hint">(at start of year)</span></label><input type="number" id="annabelleLumpSumYear" value="2030" step="1" min="2025" max="2063"></div>
                        <div class="input-group"><label>Percentage (%)</label><input type="number" id="annabelleLumpSumPct" value="25" step="1" min="0" max="25"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-2" style="margin-top: 20px;">
            <div class="card">
                <h2>Depletion Age Optimisation</h2>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Calculate the income needed to deplete pot by target age <span class="year-hint">(pot exhausts during that age year)</span>.</p>
                <div class="input-row" style="margin-bottom: 10px;">
                    <div class="input-group"><label>EI Target Depletion Age</label><input type="number" id="eugeneDepletionAge" value="90" step="1" min="66" max="100"></div>
                    <div class="input-group"><label>EI Income Start Year <span class="year-hint">(from start)</span></label><input type="number" id="eugeneDepletionStartYear" value="2030" step="1" min="2025" max="2054"></div>
                    <button class="opt-button" id="optimizeEugene">Optimise EI</button>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>AI Target Depletion Age</label><input type="number" id="annabelleDepletionAge" value="90" step="1" min="58" max="100"></div>
                    <div class="input-group"><label>AI Income Start Year <span class="year-hint">(from start)</span></label><input type="number" id="annabelleDepletionStartYear" value="2030" step="1" min="2025" max="2054"></div>
                    <button class="opt-button" id="optimizeAnnabelle">Optimise AI</button>
                </div>
                <div id="depletionResult" class="opt-result"></div>
            </div>

            <div class="card">
                <h2>Tax Efficiency Optimisation</h2>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Maximise income at 20% tax band <span class="year-hint">(from start of year)</span>.</p>
                <div class="input-row" style="margin-bottom: 14px;">
                    <div class="input-group"><label>EI Start Year <span class="year-hint">(from start)</span></label><input type="number" id="eugeneTaxOptStartYear" value="2030" step="1" min="2025" max="2054"></div>
                    <div class="input-group"><label>AI Start Year <span class="year-hint">(from start)</span></label><input type="number" id="annabelleTaxOptStartYear" value="2030" step="1" min="2025" max="2054"></div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <button class="opt-button opt-button-primary" id="optimizeTaxEugene" style="flex: 1;">Maximise EI at 20%</button>
                    <button class="opt-button opt-button-primary" id="optimizeTaxAnnabelle" style="flex: 1;">Maximise AI at 20%</button>
                </div>
                <div id="taxOptResult" class="opt-result"></div>
            </div>
        </div>

        <div id="alertsSection" class="alerts-section" style="display: none;"></div>

        <h2 class="section-title">Key Outcomes</h2>
        <div class="summary-grid" id="summaryCards"></div>

        <div class="chart-container">
            <h2>Parmenion Pension Balances Over Time</h2>
            <div id="chartWrapper" style="position: relative; height: 300px;">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>Income, Excess & Cumulative Excess</h2>
            <div id="incomeChartWrapper" style="position: relative; height: 300px;">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
        
        <div class="table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                <div>
                    <h2 style="margin: 0;">Year-by-Year Projections</h2>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin: 4px 0 0 0;">
                        üí° Click <strong>EI Target</strong> or <strong>AI Target</strong> cells to manually adjust income.<br>
                        üîí Cells locked when pot is depleted. Living costs only apply once drawdown begins.
                    </p>
                </div>
                <button class="clear-all-overrides" id="clearAllOverrides" style="display: none;">Clear All Adjustments</button>
            </div>
            <div class="table-scroll">
                <table id="dataTable" class="data-table"><thead></thead><tbody></tbody></table>
            </div>
        </div>

        <!-- PRINT SUMMARY (Page 2) -->
        <div id="printSummary" class="print-summary"></div>

        <footer>Pensions MAP &copy; 2025 ‚Äì For planning purposes only. Not financial advice.</footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    
    // Get current month in YYYY-MM format
    const getCurrentMonth = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}`;
    };
    
    const currentMonth = getCurrentMonth();
    
    const state = {
        dbGrowthRate: 0.03, dbGrowthEnabled: true,
        dcGrowthRate: 0.06, dcGrowthEnabled: true,
        statePensionGrowthRate: 0.03, statePensionGrowthEnabled: true,
        annualLivingCosts: 30000, livingCostsInflation: false,
        eugeneDrawdownStartYear: 2030, eugeneTargetIncome: 50000, eugeneInflation: true,
        eugeneMonthlyContrib: 1500, eugenePot1Balance: 286343, eugenePot2Balance: 54239, eugeneAge2025: 61,
        eugeneBalanceValidFrom: currentMonth, eugeneContribStartMonth: currentMonth,
        annabelleDrawdownStartYear: 2030, annabelleTargetIncome: 12500, annabelleInflation: true,
        annabelleMonthlyContrib: 2500, annabelleStartingBalance: 55273, annabelleAge2025: 53,
        annabelleBalanceValidFrom: currentMonth, annabelleContribStartMonth: currentMonth,
        personalAllowance: 12570, basicRateThreshold: 50270, basicRate: 0.20, higherRate: 0.40,
        taxNewThresholdsYear: 2031, taxNewPersonalAllowance: 12570, taxNewBasicRateThreshold: 50270, taxThresholdGrowthRate: 0.02,
        inflationBaseRate: 0.03, inflationChangeYear: 2025, inflationNewRate: 0.03,
        eugeneStateYear: 2031, eugeneStateAmount: 12014,
        eugeneAvonYear: 2030, eugeneAvonAmount: 5900, eugeneAvonLumpSum: 30000,
        eugeneCivilYear: 2030, eugeneCivilAmount: 4850, eugeneCivilLumpSum: 32332,
        annabelleStateYear: 2039, annabelleStateAmount: 12014,
        annabelleTeachersYear: 2038, annabelleTeachersAmount: 3800, annabelleTeachersLumpSum: 25888,
        eugeneLumpSumYear: 2030, eugeneLumpSumPct: 0.25,
        annabelleLumpSumYear: 2030, annabelleLumpSumPct: 0.25,
        eugeneContribStopYear: 2029, annabelleContribStopYear: 2029,
        eugeneTaxOptStartYear: 2030, annabelleTaxOptStartYear: 2030,
        eugeneDepletionStartYear: 2030, annabelleDepletionStartYear: 2030,
        incomeOverrides: {},
        eugeneOptimisation: null,
        annabelleOptimisation: null,
        scenarioName: null
    };

    // Helper to parse month input to year and month
    function parseMonthInput(monthStr) {
        if (!monthStr || typeof monthStr !== 'string') {
            return { year: 2025, month: 1 };
        }
        const parts = monthStr.split('-');
        const year = parseInt(parts[0]) || 2025;
        const month = parseInt(parts[1]) || 1;
        return { year, month };
    }

    // ============================================================================
    // CORE CALCULATIONS
    // ============================================================================
    function getTaxThresholds(year) {
        if (year < state.taxNewThresholdsYear) {
            return { personalAllowance: state.personalAllowance, basicRateThreshold: state.basicRateThreshold };
        }
        const g = Math.pow(1 + state.taxThresholdGrowthRate, year - state.taxNewThresholdsYear);
        return { 
            personalAllowance: Math.round(state.taxNewPersonalAllowance * g), 
            basicRateThreshold: Math.round(state.taxNewBasicRateThreshold * g) 
        };
    }

    function calculateTax(gross, year) {
        const t = getTaxThresholds(year);
        if (gross <= t.personalAllowance) return 0;
        if (gross <= t.basicRateThreshold) return (gross - t.personalAllowance) * state.basicRate;
        return (t.basicRateThreshold - t.personalAllowance) * state.basicRate + (gross - t.basicRateThreshold) * state.higherRate;
    }

    function getInflationRate(year) {
        return year < state.inflationChangeYear ? state.inflationBaseRate : state.inflationNewRate;
    }

    function calculate() {
        const results = [];
        let eugenePot = state.eugenePot1Balance + state.eugenePot2Balance;
        let annabellePot = state.annabelleStartingBalance;
        let cumInfl = 1, eugLSTaken = false, annLSTaken = false;
        let lumpSumInfo = { 
            eugeneLumpSumAmount: 0, eugeneLumpSumYear: null, 
            annabelleLumpSumAmount: 0, annabelleLumpSumYear: null 
        };
        
        // Parse balance valid dates
        const eugBalanceValid = parseMonthInput(state.eugeneBalanceValidFrom);
        const annBalanceValid = parseMonthInput(state.annabelleBalanceValidFrom);
        const eugContribStart = parseMonthInput(state.eugeneContribStartMonth);
        const annContribStart = parseMonthInput(state.annabelleContribStartMonth);
        
        // Track DB pension values (they grow each year)
        let eugStateVal = state.eugeneStateAmount;
        let eugAvonVal = state.eugeneAvonAmount;
        let eugCivilVal = state.eugeneCivilAmount;
        let annStateVal = state.annabelleStateAmount;
        let annTeachVal = state.annabelleTeachersAmount;

        for (let year = 2025; year <= 2063; year++) {
            const yi = year - 2025;
            const infl = getInflationRate(year);
            if (yi > 0) cumInfl *= (1 + infl);
            
            const eugAge = state.eugeneAge2025 + yi;
            const annAge = state.annabelleAge2025 + yi;
            const eugPhase = year >= state.eugeneDrawdownStartYear ? 'drawdown' : 'accumulation';
            const annPhase = year >= state.annabelleDrawdownStartYear ? 'drawdown' : 'accumulation';
            
            // Determine if anyone is drawing down (for living costs)
            const anyoneDrawingDown = eugPhase === 'drawdown' || annPhase === 'drawdown';

            // ========== EUGENE ==========
            let eugBase = state.eugeneTargetIncome, eugHasOvr = false;
            for (let y = state.eugeneDrawdownStartYear; y <= year; y++) {
                if (state.incomeOverrides[y]?.eugene !== undefined) {
                    eugBase = state.incomeOverrides[y].eugene;
                    eugHasOvr = true;
                    if (state.eugeneInflation) {
                        for (let iy = y + 1; iy <= year; iy++) {
                            eugBase *= (1 + getInflationRate(iy));
                        }
                    }
                    break;
                }
            }
            if (!eugHasOvr && state.eugeneInflation && eugPhase === 'drawdown') {
                eugBase = state.eugeneTargetIncome * cumInfl;
            }
            let eugTarget = eugPhase === 'drawdown' ? eugBase : 0;

            const eugState = year >= state.eugeneStateYear ? eugStateVal : 0;
            const eugAvon = year >= state.eugeneAvonYear ? eugAvonVal : 0;
            const eugCivil = year >= state.eugeneCivilYear ? eugCivilVal : 0;
            const eugDB = eugState + eugAvon + eugCivil;

            // Accumulation phase with date-aware contributions and growth
            if (eugPhase === 'accumulation') {
                // Contributions (only from contrib start month)
                if (year >= eugContribStart.year && year <= state.eugeneContribStopYear) {
                    let monthsContrib = 12;
                    if (year === eugContribStart.year) {
                        monthsContrib = 13 - eugContribStart.month; // e.g., start June = 7 months (Jun-Dec)
                    }
                    eugenePot += state.eugeneMonthlyContrib * monthsContrib;
                }
                // Growth (only after balance valid date)
                if (state.dcGrowthEnabled && year >= eugBalanceValid.year) {
                    if (year === eugBalanceValid.year) {
                        // Partial year growth
                        const monthsGrowth = 12 - eugBalanceValid.month + 1;
                        const partialRate = state.dcGrowthRate * (monthsGrowth / 12);
                        eugenePot *= (1 + partialRate);
                    } else {
                        eugenePot *= (1 + state.dcGrowthRate);
                    }
                }
            }

            // Lump sum extraction
            let eugLS = 0;
            if (!eugLSTaken && year === state.eugeneLumpSumYear && state.eugeneLumpSumPct > 0) {
                const initTotal = state.eugenePot1Balance + state.eugenePot2Balance;
                const pot2Ratio = initTotal > 0 ? state.eugenePot2Balance / initTotal : 0;
                eugLS = eugenePot * pot2Ratio * state.eugeneLumpSumPct;
                eugenePot -= eugLS;
                eugLSTaken = true;
                lumpSumInfo.eugeneLumpSumAmount = eugLS;
                lumpSumInfo.eugeneLumpSumYear = year;
            }

            // Drawdown phase
            let eugDraw = 0, eugLimited = false;
            if (eugPhase === 'drawdown') {
                if (state.dcGrowthEnabled) {
                    eugenePot *= (1 + state.dcGrowthRate);
                }
                const ideal = Math.max(0, eugTarget - eugDB);
                if (eugenePot >= ideal) {
                    eugDraw = ideal;
                    eugenePot -= eugDraw;
                } else {
                    eugDraw = Math.max(0, eugenePot);
                    eugenePot = 0;
                    eugLimited = true;
                    eugTarget = eugDB + eugDraw;
                }
            }
            const eugGross = eugDB + eugDraw;
            const eugTax = calculateTax(eugGross, year);
            const eugNet = eugGross - eugTax;

            // ========== ANNABELLE ==========
            let annBase = state.annabelleTargetIncome, annHasOvr = false;
            for (let y = state.annabelleDrawdownStartYear; y <= year; y++) {
                if (state.incomeOverrides[y]?.annabelle !== undefined) {
                    annBase = state.incomeOverrides[y].annabelle;
                    annHasOvr = true;
                    if (state.annabelleInflation) {
                        for (let iy = y + 1; iy <= year; iy++) {
                            annBase *= (1 + getInflationRate(iy));
                        }
                    }
                    break;
                }
            }
            if (!annHasOvr && state.annabelleInflation && annPhase === 'drawdown') {
                annBase = state.annabelleTargetIncome * cumInfl;
            }
            let annTarget = annPhase === 'drawdown' ? annBase : 0;

            const annState = year >= state.annabelleStateYear ? annStateVal : 0;
            const annTeach = year >= state.annabelleTeachersYear ? annTeachVal : 0;
            const annDB = annState + annTeach;

            if (annPhase === 'accumulation') {
                if (year >= annContribStart.year && year <= state.annabelleContribStopYear) {
                    let monthsContrib = 12;
                    if (year === annContribStart.year) {
                        monthsContrib = 13 - annContribStart.month;
                    }
                    annabellePot += state.annabelleMonthlyContrib * monthsContrib;
                }
                if (state.dcGrowthEnabled && year >= annBalanceValid.year) {
                    if (year === annBalanceValid.year) {
                        const monthsGrowth = 12 - annBalanceValid.month + 1;
                        const partialRate = state.dcGrowthRate * (monthsGrowth / 12);
                        annabellePot *= (1 + partialRate);
                    } else {
                        annabellePot *= (1 + state.dcGrowthRate);
                    }
                }
            }

            let annLS = 0;
            if (!annLSTaken && year === state.annabelleLumpSumYear && state.annabelleLumpSumPct > 0) {
                annLS = annabellePot * state.annabelleLumpSumPct;
                annabellePot -= annLS;
                annLSTaken = true;
                lumpSumInfo.annabelleLumpSumAmount = annLS;
                lumpSumInfo.annabelleLumpSumYear = year;
            }

            let annDraw = 0, annLimited = false;
            if (annPhase === 'drawdown') {
                if (state.dcGrowthEnabled) {
                    annabellePot *= (1 + state.dcGrowthRate);
                }
                const ideal = Math.max(0, annTarget - annDB);
                if (annabellePot >= ideal) {
                    annDraw = ideal;
                    annabellePot -= annDraw;
                } else {
                    annDraw = Math.max(0, annabellePot);
                    annabellePot = 0;
                    annLimited = true;
                    annTarget = annDB + annDraw;
                }
            }
            const annGross = annDB + annDraw;
            const annTax = calculateTax(annGross, year);
            const annNet = annGross - annTax;

            // Apply growth to DB pensions for NEXT year
            if (state.dbGrowthEnabled) {
                eugAvonVal *= (1 + state.dbGrowthRate);
                eugCivilVal *= (1 + state.dbGrowthRate);
                annTeachVal *= (1 + state.dbGrowthRate);
            }
            if (state.statePensionGrowthEnabled) {
                eugStateVal *= (1 + state.statePensionGrowthRate);
                annStateVal *= (1 + state.statePensionGrowthRate);
            }

            const totGross = eugGross + annGross;
            const totNet = eugNet + annNet;
            
            // Living costs only apply once someone is drawing down
            const living = anyoneDrawingDown 
                ? (state.livingCostsInflation ? state.annualLivingCosts * cumInfl : state.annualLivingCosts)
                : 0;
            const excessFunds = anyoneDrawingDown ? totNet - living : null;

            results.push({
                year, inflationRate: infl, eugeneAge: eugAge, annabelleAge: annAge,
                eugenePhase: eugPhase, annabellePhase: annPhase, anyoneDrawingDown,
                eugeneTargetGross: eugTarget, annabelleTargetGross: annTarget,
                eugeneHasOverride: eugHasOvr, annabelleHasOverride: annHasOvr,
                eugeneStatePension: eugState, eugeneAvon: eugAvon, eugeneCivil: eugCivil,
                eugeneDrawdown: eugDraw, eugenePot: Math.max(0, eugenePot),
                eugeneGross: eugGross, eugeneTax: eugTax, eugeneNet: eugNet, eugeneIncomeLimited: eugLimited,
                annabelleStatePension: annState, annabelleTeachers: annTeach,
                annabelleDrawdown: annDraw, annabellePot: Math.max(0, annabellePot),
                annabelleGross: annGross, annabelleTax: annTax, annabelleNet: annNet, annabelleIncomeLimited: annLimited,
                totalFamilyGross: totGross, totalFamilyNet: totNet, livingCosts: living, excessFunds
            });
        }
        return { results, lumpSumInfo };
    }

    // ============================================================================
    // DEPLETION AGE OPTIMISATION
    // ============================================================================
    function simulateDepletionForPerson(person, testIncome, incomeStartYear) {
        let pot = person === 'eugene' 
            ? state.eugenePot1Balance + state.eugenePot2Balance 
            : state.annabelleStartingBalance;
        
        let lsTaken = false;
        let exhaustionYear = null;
        let exhaustionAge = null;
        
        const ddStart = person === 'eugene' ? state.eugeneDrawdownStartYear : state.annabelleDrawdownStartYear;
        const contribStop = person === 'eugene' ? state.eugeneContribStopYear : state.annabelleContribStopYear;
        const monthly = person === 'eugene' ? state.eugeneMonthlyContrib : state.annabelleMonthlyContrib;
        const startAge = person === 'eugene' ? state.eugeneAge2025 : state.annabelleAge2025;
        const applyInfl = person === 'eugene' ? state.eugeneInflation : state.annabelleInflation;
        const lsYear = person === 'eugene' ? state.eugeneLumpSumYear : state.annabelleLumpSumYear;
        const lsPct = person === 'eugene' ? state.eugeneLumpSumPct : state.annabelleLumpSumPct;
        
        const balanceValidStr = person === 'eugene' ? state.eugeneBalanceValidFrom : state.annabelleBalanceValidFrom;
        const contribStartStr = person === 'eugene' ? state.eugeneContribStartMonth : state.annabelleContribStartMonth;
        const balanceValid = parseMonthInput(balanceValidStr);
        const contribStart = parseMonthInput(contribStartStr);

        let cumInflFromStart = 1;

        for (let year = 2025; year <= 2063; year++) {
            const yi = year - 2025;
            const age = startAge + yi;
            const phase = year >= ddStart ? 'drawdown' : 'accumulation';
            const infl = getInflationRate(year);
            
            if (yi > 0) cumInflFromStart *= (1 + infl);

            let dbIncome = 0;
            if (person === 'eugene') {
                if (year >= state.eugeneStateYear) {
                    dbIncome += state.eugeneStateAmount * Math.pow(1 + state.statePensionGrowthRate, yi);
                }
                if (year >= state.eugeneAvonYear) {
                    dbIncome += state.eugeneAvonAmount * Math.pow(1 + state.dbGrowthRate, yi);
                }
                if (year >= state.eugeneCivilYear) {
                    dbIncome += state.eugeneCivilAmount * Math.pow(1 + state.dbGrowthRate, yi);
                }
            } else {
                if (year >= state.annabelleStateYear) {
                    dbIncome += state.annabelleStateAmount * Math.pow(1 + state.statePensionGrowthRate, yi);
                }
                if (year >= state.annabelleTeachersYear) {
                    dbIncome += state.annabelleTeachersAmount * Math.pow(1 + state.dbGrowthRate, yi);
                }
            }

            if (phase === 'accumulation') {
                if (year >= contribStart.year && year <= contribStop) {
                    let monthsContrib = 12;
                    if (year === contribStart.year) monthsContrib = 13 - contribStart.month;
                    pot += monthly * monthsContrib;
                }
                if (state.dcGrowthEnabled && year >= balanceValid.year) {
                    if (year === balanceValid.year) {
                        const monthsGrowth = 12 - balanceValid.month + 1;
                        pot *= (1 + state.dcGrowthRate * (monthsGrowth / 12));
                    } else {
                        pot *= (1 + state.dcGrowthRate);
                    }
                }
            }

            if (!lsTaken && year === lsYear && lsPct > 0) {
                if (person === 'eugene') {
                    const initTotal = state.eugenePot1Balance + state.eugenePot2Balance;
                    const pot2Ratio = initTotal > 0 ? state.eugenePot2Balance / initTotal : 0;
                    pot -= pot * pot2Ratio * lsPct;
                } else {
                    pot -= pot * lsPct;
                }
                lsTaken = true;
            }

            if (phase === 'drawdown' && year >= incomeStartYear) {
                if (state.dcGrowthEnabled) {
                    pot *= (1 + state.dcGrowthRate);
                }

                let effectiveTarget = testIncome;
                if (applyInfl && year > incomeStartYear) {
                    for (let y = incomeStartYear + 1; y <= year; y++) {
                        effectiveTarget *= (1 + getInflationRate(y));
                    }
                }

                const idealDrawdown = Math.max(0, effectiveTarget - dbIncome);
                const actualDrawdown = Math.min(idealDrawdown, Math.max(0, pot));
                pot = Math.max(0, pot - actualDrawdown);

                if (pot < 1 && actualDrawdown < idealDrawdown && !exhaustionYear) {
                    exhaustionYear = year;
                    exhaustionAge = age;
                }
            }
        }

        return { finalPot: pot, exhaustionYear, exhaustionAge };
    }

    function optimizeDepletionAge(person, targetAge, incomeStartYear) {
        const startAge = person === 'eugene' ? state.eugeneAge2025 : state.annabelleAge2025;
        const targetYear = 2025 + (targetAge - startAge);
        
        if (targetYear < incomeStartYear) {
            return { success: false, message: `Target age ${targetAge} (year ${targetYear}) is before income start year ${incomeStartYear}` };
        }
        if (targetYear > 2063) {
            return { success: false, message: `Target age ${targetAge} (year ${targetYear}) is beyond model range (2063)` };
        }

        let lo = 1000, hi = 500000;
        let bestIncome = 0;
        
        for (let iter = 0; iter < 80; iter++) {
            const mid = Math.round((lo + hi) / 2);
            const result = simulateDepletionForPerson(person, mid, incomeStartYear);

            if (result.exhaustionYear === null) {
                lo = mid + 100;
                bestIncome = mid;
            } else if (result.exhaustionYear < targetYear) {
                hi = mid - 100;
            } else if (result.exhaustionYear > targetYear) {
                lo = mid + 100;
                bestIncome = mid;
            } else {
                bestIncome = mid;
                break;
            }

            if (hi - lo < 200) break;
        }

        for (let delta = 50; delta >= 10; delta = Math.floor(delta / 2)) {
            for (let adj = -200; adj <= 200; adj += delta) {
                const testIncome = bestIncome + adj;
                if (testIncome <= 0) continue;
                const result = simulateDepletionForPerson(person, testIncome, incomeStartYear);
                if (result.exhaustionYear === targetYear) {
                    bestIncome = testIncome;
                    break;
                }
            }
        }

        const verifyResult = simulateDepletionForPerson(person, bestIncome, incomeStartYear);
        
        return {
            success: true,
            income: bestIncome,
            targetAge,
            targetYear,
            actualExhaustionYear: verifyResult.exhaustionYear,
            actualExhaustionAge: verifyResult.exhaustionAge
        };
    }

    // ============================================================================
    // CHARTS
    // ============================================================================
    let balanceChart = null;
    let incomeChart = null;
    
    function drawCharts(data) {
        drawBalanceChart(data);
        drawIncomeChart(data);
    }
    
    function drawBalanceChart(data) {
        const canvas = document.getElementById('balanceChart');
        if (!canvas) return;
        
        const years = data.map(d => d.year);
        const eugenePotData = data.map(d => d.eugenePot);
        const annabellePotData = data.map(d => d.annabellePot);
        
        if (balanceChart) {
            balanceChart.data.labels = years;
            balanceChart.data.datasets[0].data = eugenePotData;
            balanceChart.data.datasets[1].data = annabellePotData;
            balanceChart.update('none');
        } else {
            const ctx = canvas.getContext('2d');
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { 
                            label: 'EI Pot', 
                            data: eugenePotData, 
                            borderColor: '#2c5282', 
                            backgroundColor: 'rgba(44,82,130,0.1)', 
                            fill: true, 
                            tension: 0.3,
                            borderWidth: 2
                        },
                        { 
                            label: 'AI Pot', 
                            data: annabellePotData, 
                            borderColor: '#38a169', 
                            backgroundColor: 'rgba(56,161,105,0.1)', 
                            fill: true, 
                            tension: 0.3,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { 
                        legend: { position: 'top' }, 
                        tooltip: { 
                            callbacks: { 
                                label: c => `${c.dataset.label}: ¬£${Math.round(c.parsed.y).toLocaleString()}` 
                            } 
                        } 
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => '¬£' + (v/1000).toFixed(0) + 'k' 
                            } 
                        } 
                    }
                }
            });
        }
    }
    
    function drawIncomeChart(data) {
        const canvas = document.getElementById('incomeChart');
        if (!canvas) return;
        
        const years = data.map(d => d.year);
        const netIncomeData = data.map(d => d.totalFamilyNet);
        const livingCostsData = data.map(d => d.livingCosts);
        const excessData = data.map(d => d.excessFunds !== null ? d.excessFunds : 0);
        
        // Calculate cumulative excess (only during drawdown)
        let cumulative = 0;
        const cumulativeExcessData = data.map(d => {
            if (d.anyoneDrawingDown && d.excessFunds !== null) {
                cumulative += d.excessFunds;
            }
            return d.anyoneDrawingDown ? cumulative : null;
        });
        
        if (incomeChart) {
            incomeChart.data.labels = years;
            incomeChart.data.datasets[0].data = netIncomeData;
            incomeChart.data.datasets[1].data = livingCostsData;
            incomeChart.data.datasets[2].data = excessData;
            incomeChart.data.datasets[3].data = cumulativeExcessData;
            incomeChart.update('none');
        } else {
            const ctx = canvas.getContext('2d');
            incomeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { 
                            label: 'Net Income', 
                            data: netIncomeData, 
                            borderColor: '#805ad5', 
                            backgroundColor: 'rgba(128,90,213,0.1)', 
                            fill: false, 
                            tension: 0.3,
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        { 
                            label: 'Living Costs', 
                            data: livingCostsData, 
                            borderColor: '#d69e2e', 
                            backgroundColor: 'rgba(214,158,46,0.1)', 
                            fill: false, 
                            tension: 0.3,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            yAxisID: 'y'
                        },
                        { 
                            label: 'Yearly Excess', 
                            data: excessData, 
                            borderColor: '#38a169', 
                            backgroundColor: d => {
                                const val = d.raw;
                                return val < 0 ? 'rgba(229,62,62,0.3)' : 'rgba(56,161,105,0.3)';
                            },
                            fill: true, 
                            tension: 0.3,
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        { 
                            label: 'Cumulative Excess', 
                            data: cumulativeExcessData, 
                            borderColor: '#e53e3e', 
                            backgroundColor: 'rgba(229,62,62,0.1)', 
                            fill: false, 
                            tension: 0.3,
                            borderWidth: 3,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: { 
                        legend: { position: 'top' }, 
                        tooltip: { 
                            callbacks: { 
                                label: c => {
                                    if (c.parsed.y === null) return null;
                                    return `${c.dataset.label}: ¬£${Math.round(c.parsed.y).toLocaleString()}`;
                                }
                            } 
                        } 
                    },
                    scales: { 
                        y: { 
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true, 
                            title: {
                                display: true,
                                text: 'Yearly (¬£)',
                                font: { size: 11 }
                            },
                            ticks: { 
                                callback: v => '¬£' + (v/1000).toFixed(0) + 'k' 
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Cumulative (¬£)',
                                font: { size: 11 }
                            },
                            ticks: { 
                                callback: v => '¬£' + (v/1000).toFixed(0) + 'k' 
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
    }
    
    function getChartImage() {
        const canvas = document.getElementById('balanceChart');
        if (!canvas) return '';
        return canvas.toDataURL('image/png', 1.0);
    }
    
    function getIncomeChartImage() {
        const canvas = document.getElementById('incomeChart');
        if (!canvas) return '';
        return canvas.toDataURL('image/png', 1.0);
    }

    // ============================================================================
    // TABLE RENDERING
    // ============================================================================
    function renderTable(data) {
        const thead = document.querySelector('#dataTable thead');
        const tbody = document.querySelector('#dataTable tbody');
        thead.innerHTML = `<tr class="header-group"><th rowspan="2">Year</th><th rowspan="2">Infl</th><th colspan="9" style="background:#ebf4ff;color:#1a365d;border-right:2px solid #1a365d;">EI</th><th colspan="9" style="background:#f0fff4;color:#1a4731;border-right:2px solid #1a4731;">AI</th><th colspan="3" style="background:#faf5ff;color:#44337a;">Family</th><th rowspan="2">Status</th></tr><tr><th>Age</th><th>Target</th><th>State</th><th>DB</th><th>Draw</th><th>Pot</th><th>Gross</th><th>Tax</th><th>Net</th><th>Age</th><th>Target</th><th>State</th><th>DB</th><th>Draw</th><th>Pot</th><th>Gross</th><th>Tax</th><th>Net</th><th>Gross</th><th>Net</th><th>Excess</th></tr>`;
        const fmt = n => '¬£' + Math.round(n).toLocaleString('en-GB');
        tbody.innerHTML = data.map(r => {
            const eEx = r.eugenePot <= 0 && r.eugenePhase === 'drawdown';
            const aEx = r.annabellePot <= 0 && r.annabellePhase === 'drawdown';
            const isEugeneStart = r.year === state.eugeneDrawdownStartYear;
            const isAnnabelleStart = r.year === state.annabelleDrawdownStartYear;
            
            // Row class - only for exhausted or income limited
            let cls = '';
            if (eEx || aEx) cls = 'exhausted';
            else if (r.eugeneIncomeLimited || r.annabelleIncomeLimited) cls = 'income-limited';
            
            const st = r.eugeneIncomeLimited || r.annabelleIncomeLimited 
                ? '<span style="color:#c53030;font-weight:600;">‚ö†Ô∏è</span>' 
                : `<span style="font-size:0.7rem;color:#718096;">E:${r.eugenePhase==='accumulation'?'A':'D'} A:${r.annabellePhase==='accumulation'?'A':'D'}</span>`;
            
            // Age cells with drawdown start indicator
            const eugAgeCell = isEugeneStart 
                ? `<td style="background:#dbeafe;font-weight:bold;">‚ñ∂ ${r.eugeneAge}</td>`
                : `<td>${r.eugeneAge}</td>`;
            const annAgeCell = isAnnabelleStart 
                ? `<td style="background:#d1fae5;font-weight:bold;">‚ñ∂ ${r.annabelleAge}</td>`
                : `<td>${r.annabelleAge}</td>`;
            
            const tCell = (p, ph, amt, lim, ovr) => {
                if (ph === 'accumulation') return '<td>-</td>';
                if (lim) return `<td class="locked-cell">${fmt(amt)} üîí</td>`;
                return `<td class="${ovr ? 'editable-cell has-override' : 'editable-cell'}" data-year="${r.year}" data-person="${p}" data-value="${Math.round(amt)}">${fmt(amt)}</td>`;
            };
            
            // Excess funds display - show dash if pre-drawdown
            const excessDisplay = r.anyoneDrawingDown 
                ? `<td class="${r.excessFunds<0?'negative':'positive'}">${fmt(r.excessFunds)}</td>`
                : `<td class="pre-drawdown">-</td>`;
            
            return `<tr class="${cls}"><td>${r.year}</td><td>${(r.inflationRate*100).toFixed(1)}%</td>${eugAgeCell}${tCell('eugene',r.eugenePhase,r.eugeneTargetGross,r.eugeneIncomeLimited,r.eugeneHasOverride)}<td>${r.eugeneStatePension>0?fmt(r.eugeneStatePension):'-'}</td><td>${(r.eugeneAvon+r.eugeneCivil)>0?fmt(r.eugeneAvon+r.eugeneCivil):'-'}</td><td>${r.eugeneDrawdown>0?fmt(r.eugeneDrawdown):(r.eugenePhase==='drawdown'?'¬£0':'-')}</td><td class="${eEx?'negative':''}">${fmt(r.eugenePot)}</td><td>${fmt(r.eugeneGross)}</td><td>${fmt(r.eugeneTax)}</td><td>${fmt(r.eugeneNet)}</td>${annAgeCell}${tCell('annabelle',r.annabellePhase,r.annabelleTargetGross,r.annabelleIncomeLimited,r.annabelleHasOverride)}<td>${r.annabelleStatePension>0?fmt(r.annabelleStatePension):'-'}</td><td>${r.annabelleTeachers>0?fmt(r.annabelleTeachers):'-'}</td><td>${r.annabelleDrawdown>0?fmt(r.annabelleDrawdown):(r.annabellePhase==='drawdown'?'¬£0':'-')}</td><td class="${aEx?'negative':''}">${fmt(r.annabellePot)}</td><td>${fmt(r.annabelleGross)}</td><td>${fmt(r.annabelleTax)}</td><td>${fmt(r.annabelleNet)}</td><td>${fmt(r.totalFamilyGross)}</td><td>${fmt(r.totalFamilyNet)}</td>${excessDisplay}<td>${st}</td></tr>`;
        }).join('');
        
        tbody.querySelectorAll('.editable-cell').forEach(c => c.addEventListener('click', handleCellClick));
        document.getElementById('clearAllOverrides').style.display = Object.keys(state.incomeOverrides).length > 0 ? 'inline-block' : 'none';
    }

    function handleCellClick(e) {
        const cell = e.currentTarget;
        if (cell.querySelector('input')) return;
        
        const year = parseInt(cell.dataset.year);
        const person = cell.dataset.person;
        const val = parseInt(cell.dataset.value);
        
        const input = document.createElement('input');
        input.type = 'number';
        input.value = val;
        input.step = 100;
        input.min = 0;
        
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        
        const save = () => {
            const nv = parseInt(input.value);
            if (!isNaN(nv) && nv >= 0) {
                if (!state.incomeOverrides[year]) state.incomeOverrides[year] = {};
                state.incomeOverrides[year][person] = nv;
                if (person === 'eugene') state.eugeneOptimisation = null;
                else state.annabelleOptimisation = null;
                update();
            }
        };
        
        input.addEventListener('blur', save);
        input.addEventListener('keydown', ev => {
            if (ev.key === 'Enter') save();
            else if (ev.key === 'Escape') update();
        });
    }

    function clearAllOverrides() {
        state.incomeOverrides = {};
        state.eugeneOptimisation = null;
        state.annabelleOptimisation = null;
        update();
    }

    // ============================================================================
    // OPTIMISATION INDICATORS
    // ============================================================================
    function updateOptIndicators() {
        const eugInd = document.getElementById('eugeneOptIndicator');
        const annInd = document.getElementById('annabelleOptIndicator');
        
        if (state.eugeneOptimisation) {
            const opt = state.eugeneOptimisation;
            if (opt.type === 'depletion') {
                eugInd.innerHTML = `<span class="opt-indicator depletion">üéØ Age Opt: ${opt.targetAge}</span>`;
            } else if (opt.type === 'tax') {
                eugInd.innerHTML = `<span class="opt-indicator tax">üí∞ Tax Opt: ¬£${opt.income.toLocaleString()}</span>`;
            }
        } else {
            eugInd.innerHTML = '';
        }
        
        if (state.annabelleOptimisation) {
            const opt = state.annabelleOptimisation;
            if (opt.type === 'depletion') {
                annInd.innerHTML = `<span class="opt-indicator depletion">üéØ Age Opt: ${opt.targetAge}</span>`;
            } else if (opt.type === 'tax') {
                annInd.innerHTML = `<span class="opt-indicator tax">üí∞ Tax Opt: ¬£${opt.income.toLocaleString()}</span>`;
            }
        } else {
            annInd.innerHTML = '';
        }
    }

    // ============================================================================
    // SUMMARY RENDERING
    // ============================================================================
    function renderSummary(data, lumpSumInfo) {
        const container = document.getElementById('summaryCards');
        const alertsSection = document.getElementById('alertsSection');
        
        const eugEx = data.find(d => d.eugeneIncomeLimited && d.eugenePhase === 'drawdown');
        const annEx = data.find(d => d.annabelleIncomeLimited && d.annabellePhase === 'drawdown');
        
        const totEx = data.filter(d => d.anyoneDrawingDown)
                         .reduce((s, d) => s + (d.excessFunds || 0), 0);
        
        const fmt = n => '¬£' + Math.round(n).toLocaleString('en-GB');
        
        // Parmenion lump sums
        const eiParmLS = lumpSumInfo?.eugeneLumpSumAmount || 0;
        const aiParmLS = lumpSumInfo?.annabelleLumpSumAmount || 0;
        
        // DB lump sums (static inputs)
        const eiAvonLS = state.eugeneAvonLumpSum || 0;
        const eiCivilLS = state.eugeneCivilLumpSum || 0;
        const aiTeachLS = state.annabelleTeachersLumpSum || 0;
        
        // Totals
        const eiTotalLS = eiParmLS + eiAvonLS + eiCivilLS;
        const aiTotalLS = aiParmLS + aiTeachLS;
        const grandTotalLS = eiTotalLS + aiTotalLS;
        
        // Alerts
        let alerts = '';
        if (eugEx) alerts += `<div class="alert-box"><h3>‚ö†Ô∏è EI Pot Exhausted</h3><p>Depleted in <strong>${eugEx.year}</strong> at age <strong>${eugEx.eugeneAge}</strong></p></div>`;
        if (annEx) alerts += `<div class="alert-box"><h3>‚ö†Ô∏è AI Pot Exhausted</h3><p>Depleted in <strong>${annEx.year}</strong> at age <strong>${annEx.annabelleAge}</strong></p></div>`;
        alertsSection.innerHTML = alerts ? `<h2 class="section-title" style="color:#c53030;">‚ö†Ô∏è Income Alerts</h2>` + alerts : '';
        alertsSection.style.display = alerts ? 'block' : 'none';
        
        container.innerHTML = `
            <div class="summary-card ${eugEx ? 'danger' : 'success'}">
                <div class="value">${eugEx ? eugEx.year : 'Never'}</div>
                ${eugEx ? `<div class="sub-value">Age ${eugEx.eugeneAge}</div>` : ''}
                <div class="label">EI Pot Exhaustion</div>
            </div>
            <div class="summary-card ${annEx ? 'danger' : 'success'}">
                <div class="value">${annEx ? annEx.year : 'Never'}</div>
                ${annEx ? `<div class="sub-value">Age ${annEx.annabelleAge}</div>` : ''}
                <div class="label">AI Pot Exhaustion</div>
            </div>
            <div class="summary-card ${totEx < 0 ? 'danger' : 'success'}">
                <div class="value">${fmt(totEx)}</div>
                <div class="label">Total Net Family Excess</div>
            </div>
            <div class="summary-card info">
                <div class="value">${fmt(eiParmLS)}</div>
                ${lumpSumInfo?.eugeneLumpSumYear ? `<div class="sub-value">${lumpSumInfo.eugeneLumpSumYear}</div>` : ''}
                <div class="label">EI Parmenion 25%</div>
            </div>
            <div class="summary-card info">
                <div class="value">${fmt(aiParmLS)}</div>
                ${lumpSumInfo?.annabelleLumpSumYear ? `<div class="sub-value">${lumpSumInfo.annabelleLumpSumYear}</div>` : ''}
                <div class="label">AI Parmenion 25%</div>
            </div>
            <div class="summary-card info">
                <div class="value">${fmt(eiAvonLS)}</div>
                <div class="label">EI Avon 25%</div>
            </div>
            <div class="summary-card info">
                <div class="value">${fmt(eiCivilLS)}</div>
                <div class="label">EI Civil Service 25%</div>
            </div>
            <div class="summary-card info">
                <div class="value">${fmt(aiTeachLS)}</div>
                <div class="label">AI Teachers 25%</div>
            </div>
            <div class="summary-card success">
                <div class="value">${fmt(grandTotalLS)}</div>
                <div class="sub-value">EI: ${fmt(eiTotalLS)} / AI: ${fmt(aiTotalLS)}</div>
                <div class="label">Total All Lump Sums</div>
            </div>
        `;
    }

    // ============================================================================
    // PRINT SUMMARY (Page 2)
    // ============================================================================
    function updatePrintSummary(data, lumpSumInfo) {
        const printSummary = document.getElementById('printSummary');
        const title = document.getElementById('printTitle').value.trim() || 'Pension Projection';
        const dateStr = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('printDateMain').textContent = `Generated: ${dateStr}`;

        const fmt = v => '¬£' + Math.round(v).toLocaleString();
        const pct = v => (v * 100).toFixed(1) + '%';
        const yn = v => v ? 'Yes' : 'No';

        const eugEx = data.find(d => d.eugenePot <= 0 && d.eugenePhase === 'drawdown');
        const annEx = data.find(d => d.annabellePot <= 0 && d.annabellePhase === 'drawdown');
        const totEx = data.filter(d => d.anyoneDrawingDown)
                         .reduce((s, d) => s + (d.excessFunds || 0), 0);
        
        // Additional key outcomes
        const lastYear = data[data.length - 1];
        const eiStartPot = state.eugenePot1Balance + state.eugenePot2Balance;
        const aiStartPot = state.annabelleStartingBalance;
        const eiDrawdownYear = state.eugeneDrawdownStartYear;
        const aiDrawdownYear = state.annabelleDrawdownStartYear;
        const eiDrawdownAge = state.eugeneAge2025 + (eiDrawdownYear - 2025);
        const aiDrawdownAge = state.annabelleAge2025 + (aiDrawdownYear - 2025);
        const eiFinalPot = lastYear ? lastYear.eugenePot : 0;
        const aiFinalPot = lastYear ? lastYear.annabellePot : 0;
        const projectionEndYear = lastYear ? lastYear.year : 2063;
        
        // Lump sums
        const eiParmLS = lumpSumInfo?.eugeneLumpSumAmount || 0;
        const aiParmLS = lumpSumInfo?.annabelleLumpSumAmount || 0;
        const eiAvonLS = state.eugeneAvonLumpSum || 0;
        const eiCivilLS = state.eugeneCivilLumpSum || 0;
        const aiTeachLS = state.annabelleTeachersLumpSum || 0;
        const eiTotalLS = eiParmLS + eiAvonLS + eiCivilLS;
        const aiTotalLS = aiParmLS + aiTeachLS;
        const grandTotalLS = eiTotalLS + aiTotalLS;

        // Get chart images
        const chartImage = getChartImage();
        const incomeChartImage = getIncomeChartImage();

        const row = (l, v) => `<div style="display:flex;justify-content:space-between;padding:1px 0;border-bottom:1px dotted #ddd;font-size:7.5pt;"><span style="color:#333;">${l}</span><span style="font-weight:bold;color:#000;">${v}</span></div>`;

        // Optimisation info
        let eugOptInfo = '';
        if (state.eugeneOptimisation) {
            eugOptInfo = state.eugeneOptimisation.type === 'depletion' 
                ? `<div style="font-size:7pt;color:#dd6b20;font-weight:bold;background:#fff7ed;padding:2px 4px;margin-bottom:2px;border-radius:2px;">üéØ Age Opt: ${state.eugeneOptimisation.targetAge}</div>`
                : `<div style="font-size:7pt;color:#38a169;font-weight:bold;background:#f0fff4;padding:2px 4px;margin-bottom:2px;border-radius:2px;">üí∞ Tax Opt</div>`;
        }
        
        let annOptInfo = '';
        if (state.annabelleOptimisation) {
            annOptInfo = state.annabelleOptimisation.type === 'depletion'
                ? `<div style="font-size:7pt;color:#dd6b20;font-weight:bold;background:#fff7ed;padding:2px 4px;margin-bottom:2px;border-radius:2px;">üéØ Age Opt: ${state.annabelleOptimisation.targetAge}</div>`
                : `<div style="font-size:7pt;color:#38a169;font-weight:bold;background:#f0fff4;padding:2px 4px;margin-bottom:2px;border-radius:2px;">üí∞ Tax Opt</div>`;
        }

        printSummary.innerHTML = `
        <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#000;background:#fff;">
            <div style="text-align:center;border-bottom:2px solid #1a365d;padding-bottom:4px;margin-bottom:6px;">
                <div style="font-size:14pt;font-weight:bold;color:#1a365d;">${title}</div>
                <div style="font-size:8pt;color:#333;">Generated: ${dateStr}</div>
            </div>

            <!-- Key Outcomes - Row 1 -->
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:nowrap;">
                <div style="flex:1;border:2px solid ${eugEx?'#c53030':'#38a169'};padding:3px;text-align:center;background:${eugEx?'#fff5f5':'#f0fff4'};">
                    <div style="font-size:9pt;font-weight:bold;color:${eugEx?'#c53030':'#38a169'};">${eugEx ? eugEx.year : 'Never'}</div>
                    ${eugEx ? `<div style="font-size:7pt;color:#666;">Age ${eugEx.eugeneAge}</div>` : ''}
                    <div style="font-size:6pt;color:#666;">EI Pot Exhaustion</div>
                </div>
                <div style="flex:1;border:2px solid ${annEx?'#c53030':'#38a169'};padding:3px;text-align:center;background:${annEx?'#fff5f5':'#f0fff4'};">
                    <div style="font-size:9pt;font-weight:bold;color:${annEx?'#c53030':'#38a169'};">${annEx ? annEx.year : 'Never'}</div>
                    ${annEx ? `<div style="font-size:7pt;color:#666;">Age ${annEx.annabelleAge}</div>` : ''}
                    <div style="font-size:6pt;color:#666;">AI Pot Exhaustion</div>
                </div>
                <div style="flex:1;border:2px solid ${totEx<0?'#c53030':'#38a169'};padding:3px;text-align:center;background:${totEx<0?'#fff5f5':'#f0fff4'};">
                    <div style="font-size:9pt;font-weight:bold;color:${totEx<0?'#c53030':'#38a169'};">${fmt(totEx)}</div>
                    <div style="font-size:6pt;color:#666;">Total Net Excess</div>
                </div>
                <div style="flex:1;border:1px solid #2c5282;padding:3px;text-align:center;background:#ebf4ff;">
                    <div style="font-size:9pt;font-weight:bold;color:#2c5282;">${fmt(grandTotalLS)}</div>
                    <div style="font-size:6pt;color:#666;">All 25% Lump Sums</div>
                </div>
            </div>
            
            <!-- Key Outcomes - Row 2 -->
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:nowrap;">
                <div style="flex:1;border:1px solid #2c5282;padding:3px;text-align:center;">
                    <div style="font-size:8pt;font-weight:bold;color:#2c5282;">${eiDrawdownYear}</div>
                    <div style="font-size:6pt;color:#666;">EI Drawdown (Age ${eiDrawdownAge})</div>
                </div>
                <div style="flex:1;border:1px solid #38a169;padding:3px;text-align:center;">
                    <div style="font-size:8pt;font-weight:bold;color:#38a169;">${aiDrawdownYear}</div>
                    <div style="font-size:6pt;color:#666;">AI Drawdown (Age ${aiDrawdownAge})</div>
                </div>
                <div style="flex:1;border:1px solid #2c5282;padding:3px;text-align:center;">
                    <div style="font-size:8pt;font-weight:bold;color:#2c5282;">${fmt(eiStartPot)}</div>
                    <div style="font-size:6pt;color:#666;">EI Start Pot</div>
                </div>
                <div style="flex:1;border:1px solid #38a169;padding:3px;text-align:center;">
                    <div style="font-size:8pt;font-weight:bold;color:#38a169;">${fmt(aiStartPot)}</div>
                    <div style="font-size:6pt;color:#666;">AI Start Pot</div>
                </div>
                <div style="flex:1;border:1px solid ${eiFinalPot>0?'#38a169':'#c53030'};padding:3px;text-align:center;">
                    <div style="font-size:8pt;font-weight:bold;color:${eiFinalPot>0?'#38a169':'#c53030'};">${fmt(eiFinalPot)}</div>
                    <div style="font-size:6pt;color:#666;">EI End Pot (${projectionEndYear})</div>
                </div>
                <div style="flex:1;border:1px solid ${aiFinalPot>0?'#38a169':'#c53030'};padding:3px;text-align:center;">
                    <div style="font-size:8pt;font-weight:bold;color:${aiFinalPot>0?'#38a169':'#c53030'};">${fmt(aiFinalPot)}</div>
                    <div style="font-size:6pt;color:#666;">AI End Pot (${projectionEndYear})</div>
                </div>
            </div>

            <!-- Lump Sum Breakdown -->
            <div style="display:flex;gap:4px;margin-bottom:4px;font-size:7pt;">
                <div style="flex:1;border:1px solid #ccc;padding:2px;text-align:center;">
                    <div style="font-weight:bold;">${fmt(eiParmLS)}</div><div style="color:#666;">EI Parmenion</div>
                </div>
                <div style="flex:1;border:1px solid #ccc;padding:2px;text-align:center;">
                    <div style="font-weight:bold;">${fmt(eiAvonLS)}</div><div style="color:#666;">EI Avon</div>
                </div>
                <div style="flex:1;border:1px solid #ccc;padding:2px;text-align:center;">
                    <div style="font-weight:bold;">${fmt(eiCivilLS)}</div><div style="color:#666;">EI Civil Svc</div>
                </div>
                <div style="flex:1;border:1px solid #2c5282;padding:2px;text-align:center;background:#ebf4ff;">
                    <div style="font-weight:bold;color:#2c5282;">${fmt(eiTotalLS)}</div><div style="color:#666;">EI Total</div>
                </div>
                <div style="flex:1;border:1px solid #ccc;padding:2px;text-align:center;">
                    <div style="font-weight:bold;">${fmt(aiParmLS)}</div><div style="color:#666;">AI Parmenion</div>
                </div>
                <div style="flex:1;border:1px solid #ccc;padding:2px;text-align:center;">
                    <div style="font-weight:bold;">${fmt(aiTeachLS)}</div><div style="color:#666;">AI Teachers</div>
                </div>
                <div style="flex:1;border:1px solid #38a169;padding:2px;text-align:center;background:#f0fff4;">
                    <div style="font-weight:bold;color:#38a169;">${fmt(aiTotalLS)}</div><div style="color:#666;">AI Total</div>
                </div>
            </div>

            <!-- Charts -->
            <div style="display:flex;gap:5px;margin-bottom:6px;">
                <div style="flex:1;border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7pt;font-weight:bold;color:#1a365d;margin-bottom:2px;text-align:center;">Pension Balances</div>
                    <img src="${chartImage}" style="width:100%;height:100px;display:block;" />
                </div>
                <div style="flex:1;border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7pt;font-weight:bold;color:#1a365d;margin-bottom:2px;text-align:center;">Income & Excess</div>
                    <img src="${incomeChartImage}" style="width:100%;height:100px;display:block;" />
                </div>
            </div>

            <!-- Parameters Grid -->
            <div style="font-size:8pt;font-weight:bold;color:#1a365d;margin-bottom:3px;text-align:center;">Scenario Parameters</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;">
                <div style="border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7.5pt;font-weight:bold;color:#1a365d;border-bottom:1px solid #ccc;margin-bottom:2px;padding-bottom:1px;">Global</div>
                    ${row('DB Growth', pct(state.dbGrowthRate) + (state.dbGrowthEnabled ? ' ‚úì' : ' ‚úó'))}
                    ${row('DC Growth', pct(state.dcGrowthRate) + (state.dcGrowthEnabled ? ' ‚úì' : ' ‚úó'))}
                    ${row('State Pen Growth', pct(state.statePensionGrowthRate) + (state.statePensionGrowthEnabled ? ' ‚úì' : ' ‚úó'))}
                    ${row('Living Costs', fmt(state.annualLivingCosts) + (state.livingCostsInflation ? ' +Infl' : ''))}
                </div>
                <div style="border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7.5pt;font-weight:bold;color:#1a365d;border-bottom:1px solid #ccc;margin-bottom:2px;padding-bottom:1px;">Tax & Inflation</div>
                    ${row('Personal Allow', fmt(state.personalAllowance))}
                    ${row('Basic Rate Thresh', fmt(state.basicRateThreshold))}
                    ${row('New Thresh (start)', state.taxNewThresholdsYear)}
                    ${row('Inflation', pct(state.inflationBaseRate) + ' ‚Üí ' + pct(state.inflationNewRate))}
                </div>
                <div style="border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7.5pt;font-weight:bold;color:#1a365d;border-bottom:1px solid #ccc;margin-bottom:2px;padding-bottom:1px;">EI Parameters</div>
                    ${eugOptInfo}
                    ${row('Drawdown (start)', state.eugeneDrawdownStartYear)}
                    ${row('Target Income', fmt(state.eugeneTargetIncome) + (state.eugeneInflation ? ' +Infl' : ''))}
                    ${row('Contrib', fmt(state.eugeneMonthlyContrib) + '/mo to ' + state.eugeneContribStopYear)}
                    ${row('Balance Valid', state.eugeneBalanceValidFrom)}
                    ${row('Pot Total', fmt(state.eugenePot1Balance + state.eugenePot2Balance))}
                </div>
                <div style="border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7.5pt;font-weight:bold;color:#1a365d;border-bottom:1px solid #ccc;margin-bottom:2px;padding-bottom:1px;">AI Parameters</div>
                    ${annOptInfo}
                    ${row('Drawdown (start)', state.annabelleDrawdownStartYear)}
                    ${row('Target Income', fmt(state.annabelleTargetIncome) + (state.annabelleInflation ? ' +Infl' : ''))}
                    ${row('Contrib', fmt(state.annabelleMonthlyContrib) + '/mo to ' + state.annabelleContribStopYear)}
                    ${row('Balance Valid', state.annabelleBalanceValidFrom)}
                    ${row('Starting Balance', fmt(state.annabelleStartingBalance))}
                </div>
                <div style="border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7.5pt;font-weight:bold;color:#1a365d;border-bottom:1px solid #ccc;margin-bottom:2px;padding-bottom:1px;">EI DB Pensions</div>
                    ${row('State', fmt(state.eugeneStateAmount) + ' @ ' + state.eugeneStateYear)}
                    ${row('Avon', fmt(state.eugeneAvonAmount) + ' @ ' + state.eugeneAvonYear)}
                    ${row('Civil Svc', fmt(state.eugeneCivilAmount) + ' @ ' + state.eugeneCivilYear)}
                    ${row('Parm 25%', pct(state.eugeneLumpSumPct) + ' @ ' + state.eugeneLumpSumYear)}
                </div>
                <div style="border:1px solid #ccc;padding:3px;">
                    <div style="font-size:7.5pt;font-weight:bold;color:#1a365d;border-bottom:1px solid #ccc;margin-bottom:2px;padding-bottom:1px;">AI DB Pensions</div>
                    ${row('State', fmt(state.annabelleStateAmount) + ' @ ' + state.annabelleStateYear)}
                    ${row('Teachers', fmt(state.annabelleTeachersAmount) + ' @ ' + state.annabelleTeachersYear)}
                    ${row('Parm 25%', pct(state.annabelleLumpSumPct) + ' @ ' + state.annabelleLumpSumYear)}
                </div>
            </div>
            <div style="text-align:center;font-size:6pt;color:#666;margin-top:5px;">Pensions MAP ‚Äì For planning purposes only. Not financial advice.</div>
        </div>
        `;
    }

    // ============================================================================
    // INPUT BINDINGS
    // ============================================================================
    function bindInputs() {
        const bindings = [
            { id: 'dbGrowthRate', key: 'dbGrowthRate', transform: v => v / 100 },
            { id: 'dbGrowthEnabled', key: 'dbGrowthEnabled', isCheckbox: true },
            { id: 'dcGrowthRate', key: 'dcGrowthRate', transform: v => v / 100 },
            { id: 'dcGrowthEnabled', key: 'dcGrowthEnabled', isCheckbox: true },
            { id: 'statePensionGrowthRate', key: 'statePensionGrowthRate', transform: v => v / 100 },
            { id: 'statePensionGrowthEnabled', key: 'statePensionGrowthEnabled', isCheckbox: true },
            { id: 'annualLivingCosts', key: 'annualLivingCosts' },
            { id: 'livingCostsInflation', key: 'livingCostsInflation', isCheckbox: true },
            { id: 'eugeneDrawdownStartYear', key: 'eugeneDrawdownStartYear' },
            { id: 'eugeneTargetIncome', key: 'eugeneTargetIncome' },
            { id: 'eugeneInflation', key: 'eugeneInflation', isCheckbox: true },
            { id: 'eugeneMonthlyContrib', key: 'eugeneMonthlyContrib' },
            { id: 'eugeneContribStartMonth', key: 'eugeneContribStartMonth', isMonth: true },
            { id: 'eugenePot1Balance', key: 'eugenePot1Balance' },
            { id: 'eugenePot2Balance', key: 'eugenePot2Balance' },
            { id: 'eugeneBalanceValidFrom', key: 'eugeneBalanceValidFrom', isMonth: true },
            { id: 'eugeneAge2025', key: 'eugeneAge2025' },
            { id: 'eugeneContribStopYear', key: 'eugeneContribStopYear' },
            { id: 'annabelleDrawdownStartYear', key: 'annabelleDrawdownStartYear' },
            { id: 'annabelleTargetIncome', key: 'annabelleTargetIncome' },
            { id: 'annabelleInflation', key: 'annabelleInflation', isCheckbox: true },
            { id: 'annabelleMonthlyContrib', key: 'annabelleMonthlyContrib' },
            { id: 'annabelleContribStartMonth', key: 'annabelleContribStartMonth', isMonth: true },
            { id: 'annabelleStartingBalance', key: 'annabelleStartingBalance' },
            { id: 'annabelleBalanceValidFrom', key: 'annabelleBalanceValidFrom', isMonth: true },
            { id: 'annabelleAge2025', key: 'annabelleAge2025' },
            { id: 'annabelleContribStopYear', key: 'annabelleContribStopYear' },
            { id: 'personalAllowance', key: 'personalAllowance' },
            { id: 'basicRateThreshold', key: 'basicRateThreshold' },
            { id: 'taxNewThresholdsYear', key: 'taxNewThresholdsYear' },
            { id: 'inflationBaseRate', key: 'inflationBaseRate', transform: v => v / 100 },
            { id: 'inflationChangeYear', key: 'inflationChangeYear' },
            { id: 'inflationNewRate', key: 'inflationNewRate', transform: v => v / 100 },
            { id: 'eugeneStateYear', key: 'eugeneStateYear' }, { id: 'eugeneStateAmount', key: 'eugeneStateAmount' },
            { id: 'eugeneAvonYear', key: 'eugeneAvonYear' }, { id: 'eugeneAvonAmount', key: 'eugeneAvonAmount' },
            { id: 'eugeneAvonLumpSum', key: 'eugeneAvonLumpSum' },
            { id: 'eugeneCivilYear', key: 'eugeneCivilYear' }, { id: 'eugeneCivilAmount', key: 'eugeneCivilAmount' },
            { id: 'eugeneCivilLumpSum', key: 'eugeneCivilLumpSum' },
            { id: 'annabelleStateYear', key: 'annabelleStateYear' }, { id: 'annabelleStateAmount', key: 'annabelleStateAmount' },
            { id: 'annabelleTeachersYear', key: 'annabelleTeachersYear' }, { id: 'annabelleTeachersAmount', key: 'annabelleTeachersAmount' },
            { id: 'annabelleTeachersLumpSum', key: 'annabelleTeachersLumpSum' },
            { id: 'eugeneLumpSumYear', key: 'eugeneLumpSumYear' }, { id: 'eugeneLumpSumPct', key: 'eugeneLumpSumPct', transform: v => v / 100 },
            { id: 'annabelleLumpSumYear', key: 'annabelleLumpSumYear' }, { id: 'annabelleLumpSumPct', key: 'annabelleLumpSumPct', transform: v => v / 100 }
        ];
        
        bindings.forEach(({ id, key, transform, isCheckbox, isMonth }) => {
            const el = document.getElementById(id);
            if (!el) return;
            const eventType = isCheckbox ? 'change' : 'input';
            el.addEventListener(eventType, () => {
                if (isCheckbox) {
                    state[key] = el.checked;
                } else if (isMonth) {
                    state[key] = el.value;
                } else {
                    state[key] = transform ? transform(parseFloat(el.value) || 0) : (parseFloat(el.value) || 0);
                }
                update();
            });
        });
    }

    function update() {
        const { results: data, lumpSumInfo } = calculate();
        renderSummary(data, lumpSumInfo);
        drawCharts(data);
        renderTable(data);
        updateOptIndicators();
        updatePrintSummary(data, lumpSumInfo);
    }

    // ============================================================================
    // SAVE / LOAD / PRINT
    // ============================================================================
    function printScenario() {
        const title = document.getElementById('printTitle').value.trim() || 'Pension Projection';
        document.getElementById('printTitleMain').textContent = title;
        const { results: data, lumpSumInfo } = calculate();
        
        // Update print summary with current data
        updatePrintSummary(data, lumpSumInfo);
        
        // Small delay to ensure everything is rendered
        setTimeout(() => {
            window.print();
        }, 100);
    }

    function saveScenario() {
        const currentName = state.scenarioName || 'My Pension Scenario';
        const name = prompt('Enter a name for this scenario:', currentName);
        if (!name) return;
        
        // Store the scenario name and update print title
        state.scenarioName = name;
        document.getElementById('printTitle').value = name;
        
        const blob = new Blob([JSON.stringify({ 
            name, 
            savedAt: new Date().toISOString(), 
            version: '2.3', 
            state: { ...state } 
        }, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${name.replace(/[^a-z0-9]/gi, '_')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function loadScenario(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const sc = JSON.parse(e.target.result);
                if (!sc.state) throw new Error('Invalid file format');
                Object.assign(state, sc.state);
                
                // Update scenario name and print title
                state.scenarioName = sc.name;
                document.getElementById('printTitle').value = sc.name || 'Pension Projection';
                
                // Update form fields
                document.querySelectorAll('input[type="number"], input[type="month"]').forEach(el => {
                    if (state[el.id] !== undefined) {
                        el.value = typeof state[el.id] === 'number' && el.id.includes('Rate') || el.id.includes('Pct')
                            ? state[el.id] * 100 
                            : state[el.id];
                    }
                });
                document.querySelectorAll('input[type="checkbox"]').forEach(el => {
                    if (state[el.id] !== undefined) el.checked = state[el.id];
                });
                update();
                alert(`Loaded "${sc.name}" successfully`);
            } catch (err) {
                alert('Error loading file: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    // ============================================================================
    // INIT
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize month inputs to current month
        const monthFields = ['eugeneBalanceValidFrom', 'eugeneContribStartMonth', 
                            'annabelleBalanceValidFrom', 'annabelleContribStartMonth'];
        monthFields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = currentMonth;
        });
        
        bindInputs();
        document.getElementById('clearAllOverrides').addEventListener('click', clearAllOverrides);

        // Depletion Age Optimisation
        document.getElementById('optimizeEugene').addEventListener('click', () => {
            const targetAge = parseInt(document.getElementById('eugeneDepletionAge').value);
            const startYear = parseInt(document.getElementById('eugeneDepletionStartYear').value);
            const div = document.getElementById('depletionResult');
            
            const result = optimizeDepletionAge('eugene', targetAge, startYear);
            
            if (result.success) {
                // Update drawdown start year to match
                state.eugeneDrawdownStartYear = startYear;
                document.getElementById('eugeneDrawdownStartYear').value = startYear;
                
                if (!state.incomeOverrides[startYear]) state.incomeOverrides[startYear] = {};
                state.incomeOverrides[startYear].eugene = result.income;
                state.eugeneOptimisation = { type: 'depletion', year: startYear, income: result.income, targetAge };
                
                let msg = `<strong>EI Age Optimised:</strong> ¬£${result.income.toLocaleString()}/yr from start of ${startYear}`;
                if (result.actualExhaustionYear) {
                    msg += `<br><span style="font-size:0.85em;">Pot depletes in ${result.actualExhaustionYear} (age ${result.actualExhaustionAge})</span>`;
                }
                div.innerHTML = msg;
                div.className = 'opt-result visible';
                
                // Clear tax optimisation result
                document.getElementById('taxOptResult').innerHTML = '';
                document.getElementById('taxOptResult').className = 'opt-result';
                
                update();
            } else {
                div.innerHTML = `<strong>Error:</strong> ${result.message}`;
                div.className = 'opt-result visible warning';
            }
        });

        document.getElementById('optimizeAnnabelle').addEventListener('click', () => {
            const targetAge = parseInt(document.getElementById('annabelleDepletionAge').value);
            const startYear = parseInt(document.getElementById('annabelleDepletionStartYear').value);
            const div = document.getElementById('depletionResult');
            
            const result = optimizeDepletionAge('annabelle', targetAge, startYear);
            
            if (result.success) {
                // Update drawdown start year to match
                state.annabelleDrawdownStartYear = startYear;
                document.getElementById('annabelleDrawdownStartYear').value = startYear;
                
                if (!state.incomeOverrides[startYear]) state.incomeOverrides[startYear] = {};
                state.incomeOverrides[startYear].annabelle = result.income;
                state.annabelleOptimisation = { type: 'depletion', year: startYear, income: result.income, targetAge };
                
                let msg = `<strong>AI Age Optimised:</strong> ¬£${result.income.toLocaleString()}/yr from start of ${startYear}`;
                if (result.actualExhaustionYear) {
                    msg += `<br><span style="font-size:0.85em;">Pot depletes in ${result.actualExhaustionYear} (age ${result.actualExhaustionAge})</span>`;
                }
                div.innerHTML = msg;
                div.className = 'opt-result visible';
                
                // Clear tax optimisation result
                document.getElementById('taxOptResult').innerHTML = '';
                document.getElementById('taxOptResult').className = 'opt-result';
                
                update();
            } else {
                div.innerHTML = `<strong>Error:</strong> ${result.message}`;
                div.className = 'opt-result visible warning';
            }
        });

        // Tax Efficiency Optimisation
        document.getElementById('optimizeTaxEugene').addEventListener('click', () => {
            const yr = parseInt(document.getElementById('eugeneTaxOptStartYear').value);
            const max = getTaxThresholds(yr).basicRateThreshold;
            
            // Update drawdown start year to match
            state.eugeneDrawdownStartYear = yr;
            document.getElementById('eugeneDrawdownStartYear').value = yr;
            
            if (!state.incomeOverrides[yr]) state.incomeOverrides[yr] = {};
            state.incomeOverrides[yr].eugene = max;
            state.eugeneOptimisation = { type: 'tax', year: yr, income: max };
            
            document.getElementById('taxOptResult').innerHTML = `<strong>EI Tax Optimised:</strong> ¬£${max.toLocaleString()}/yr from start of ${yr}`;
            document.getElementById('taxOptResult').className = 'opt-result visible';
            
            // Clear depletion optimisation result
            document.getElementById('depletionResult').innerHTML = '';
            document.getElementById('depletionResult').className = 'opt-result';
            
            update();
        });

        document.getElementById('optimizeTaxAnnabelle').addEventListener('click', () => {
            const yr = parseInt(document.getElementById('annabelleTaxOptStartYear').value);
            const max = getTaxThresholds(yr).basicRateThreshold;
            
            // Update drawdown start year to match
            state.annabelleDrawdownStartYear = yr;
            document.getElementById('annabelleDrawdownStartYear').value = yr;
            
            if (!state.incomeOverrides[yr]) state.incomeOverrides[yr] = {};
            state.incomeOverrides[yr].annabelle = max;
            state.annabelleOptimisation = { type: 'tax', year: yr, income: max };
            
            document.getElementById('taxOptResult').innerHTML = `<strong>AI Tax Optimised:</strong> ¬£${max.toLocaleString()}/yr from start of ${yr}`;
            document.getElementById('taxOptResult').className = 'opt-result visible';
            
            // Clear depletion optimisation result
            document.getElementById('depletionResult').innerHTML = '';
            document.getElementById('depletionResult').className = 'opt-result';
            
            update();
        });

        // Save/Load/Print
        document.getElementById('saveScenario').addEventListener('click', saveScenario);
        document.getElementById('loadScenario').addEventListener('click', () => document.getElementById('loadScenarioFile').click());
        document.getElementById('loadScenarioFile').addEventListener('change', e => {
            if (e.target.files.length) {
                loadScenario(e.target.files[0]);
                e.target.value = '';
            }
        });
        document.getElementById('printScenario').addEventListener('click', printScenario);

        // Initial render
        update();
        
        window.addEventListener('resize', () => {
            const { results } = calculate();
            drawCharts(results);
        });
    });
    </script>
</body>
</html>
